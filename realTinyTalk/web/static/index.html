<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>realTinyTalk â€” The Friendly Programming Language</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RETRO SPLASH SCREEN (NeXTSTEP / Classic Mac style)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #c0c0c0 0%, #a0a0a0 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.8s ease;
            font-family: 'Chicago', 'Geneva', 'Helvetica Neue', Arial, sans-serif;
        }
        
        #splash.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .splash-window {
            background: #ffffff;
            border: 2px solid #000;
            box-shadow: 
                2px 2px 0 #000,
                inset -1px -1px 0 #808080,
                inset 1px 1px 0 #dfdfdf;
            padding: 0;
            width: 420px;
        }
        
        .splash-titlebar {
            background: linear-gradient(90deg, #000080 0%, #1084d0 100%);
            padding: 4px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .splash-titlebar-text {
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
            letter-spacing: 0.5px;
        }
        
        .splash-content {
            padding: 24px 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(180deg, #efefef 0%, #d4d4d4 100%);
        }
        
        .splash-logo {
            width: 96px;
            height: 96px;
            background: #000;
            border: 3px solid #000;
            box-shadow: 
                inset -2px -2px 0 #404040,
                inset 2px 2px 0 #606060,
                4px 4px 0 rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Monaco', 'Courier New', monospace;
            font-weight: bold;
            font-size: 28px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            letter-spacing: -2px;
        }
        
        .splash-title {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #000;
            text-shadow: 1px 1px 0 #fff;
            letter-spacing: -0.5px;
        }
        
        .splash-version {
            margin-top: 4px;
            font-size: 11px;
            color: #444;
        }
        
        .splash-divider {
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #808080, transparent);
            margin: 20px 0;
        }
        
        .splash-loading {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .splash-bar-container {
            width: 280px;
            height: 20px;
            background: #fff;
            border: 2px solid #000;
            box-shadow: 
                inset -1px -1px 0 #dfdfdf,
                inset 1px 1px 0 #808080;
            padding: 2px;
        }
        
        .splash-bar-fill {
            height: 100%;
            width: 0%;
            background: repeating-linear-gradient(
                90deg,
                #000080 0px,
                #000080 8px,
                #0000b0 8px,
                #0000b0 16px
            );
            transition: width 0.4s ease;
        }
        
        .splash-status {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            color: #000;
            height: 14px;
        }
        
        .splash-extensions {
            margin-top: 16px;
            font-size: 10px;
            color: #666;
            text-align: center;
            font-family: 'Monaco', 'Courier New', monospace;
        }
        
        .splash-ext-item {
            opacity: 0;
            animation: fadeInExt 0.3s ease forwards;
        }
        
        @keyframes fadeInExt {
            to { opacity: 1; }
        }
        
        .splash-copyright {
            margin-top: 20px;
            font-size: 9px;
            color: #666;
            text-align: center;
        }
        
        .splash-icon-row {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }
        
        .splash-icon {
            width: 32px;
            height: 32px;
            background: #fff;
            border: 2px solid #000;
            box-shadow: 
                inset -1px -1px 0 #808080,
                inset 1px 1px 0 #dfdfdf;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           THEME SYSTEM - CSS Custom Properties
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        :root {
            /* Default: Dark Theme (GitHub Dark) */
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-hover: #30363d;
            --border: #30363d;
            --border-subtle: #21262d;
            
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            
            --accent: #58a6ff;
            --accent-hover: #79c0ff;
            --accent-subtle: rgba(56, 139, 253, 0.15);
            
            --success: #3fb950;
            --success-subtle: rgba(46, 160, 67, 0.15);
            --error: #f85149;
            --error-subtle: rgba(248, 81, 73, 0.15);
            --warning: #d29922;
            --warning-subtle: rgba(187, 128, 9, 0.15);
            
            /* Syntax Colors - Consistent & Beautiful */
            --syn-keyword: #ff7b72;
            --syn-function: #d2a8ff;
            --syn-string: #a5d6ff;
            --syn-number: #79c0ff;
            --syn-comment: #8b949e;
            --syn-operator: #ff7b72;
            --syn-variable: #ffa657;
            --syn-type: #7ee787;
            --syn-constant: #79c0ff;
            
            /* Spacing */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #eaeef2;
            --bg-hover: #d0d7de;
            --border: #d0d7de;
            --border-subtle: #eaeef2;
            
            --text-primary: #1f2328;
            --text-secondary: #57606a;
            --text-muted: #8b949e;
            
            --accent: #0969da;
            --accent-hover: #0550ae;
            --accent-subtle: rgba(9, 105, 218, 0.1);
            
            --success: #1a7f37;
            --success-subtle: rgba(26, 127, 55, 0.1);
            --error: #cf222e;
            --error-subtle: rgba(207, 34, 46, 0.1);
            
            --syn-keyword: #cf222e;
            --syn-function: #8250df;
            --syn-string: #0a3069;
            --syn-number: #0550ae;
            --syn-comment: #6e7781;
            --syn-operator: #cf222e;
            --syn-variable: #953800;
            --syn-type: #116329;
            --syn-constant: #0550ae;
        }

        /* Monokai Theme */
        [data-theme="monokai"] {
            --bg-primary: #272822;
            --bg-secondary: #1e1f1c;
            --bg-tertiary: #3e3d32;
            --bg-hover: #49483e;
            --border: #3e3d32;
            --border-subtle: #3e3d32;
            
            --text-primary: #f8f8f2;
            --text-secondary: #a6a28c;
            --text-muted: #75715e;
            
            --accent: #66d9ef;
            --accent-hover: #9de0f2;
            --accent-subtle: rgba(102, 217, 239, 0.15);
            
            --success: #a6e22e;
            --success-subtle: rgba(166, 226, 46, 0.15);
            --error: #f92672;
            --error-subtle: rgba(249, 38, 114, 0.15);
            
            --syn-keyword: #f92672;
            --syn-function: #a6e22e;
            --syn-string: #e6db74;
            --syn-number: #ae81ff;
            --syn-comment: #75715e;
            --syn-operator: #f92672;
            --syn-variable: #fd971f;
            --syn-type: #66d9ef;
            --syn-constant: #ae81ff;
        }

        /* Nord Theme */
        [data-theme="nord"] {
            --bg-primary: #2e3440;
            --bg-secondary: #3b4252;
            --bg-tertiary: #434c5e;
            --bg-hover: #4c566a;
            --border: #4c566a;
            --border-subtle: #434c5e;
            
            --text-primary: #eceff4;
            --text-secondary: #d8dee9;
            --text-muted: #81a1c1;
            
            --accent: #88c0d0;
            --accent-hover: #8fbcbb;
            --accent-subtle: rgba(136, 192, 208, 0.15);
            
            --success: #a3be8c;
            --success-subtle: rgba(163, 190, 140, 0.15);
            --error: #bf616a;
            --error-subtle: rgba(191, 97, 106, 0.15);
            
            --syn-keyword: #81a1c1;
            --syn-function: #88c0d0;
            --syn-string: #a3be8c;
            --syn-number: #b48ead;
            --syn-comment: #616e88;
            --syn-operator: #81a1c1;
            --syn-variable: #d08770;
            --syn-type: #8fbcbb;
            --syn-constant: #b48ead;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BASE STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background 0.2s ease, color 0.2s ease;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HEADER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 56px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent), var(--syn-function));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: #fff;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            background: var(--accent-subtle);
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BUTTONS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .btn {
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-hover);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border-color: transparent;
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-icon-only {
            padding: 6px;
            min-width: 32px;
            justify-content: center;
        }

        kbd {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SELECT / DROPDOWN
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .select-wrapper {
            position: relative;
        }

        .select {
            font-family: inherit;
            font-size: 13px;
            padding: 6px 28px 6px 10px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
            min-width: 120px;
            transition: all 0.15s ease;
        }

        .select:hover {
            border-color: var(--text-muted);
        }

        .select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-subtle);
        }

        .select-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-muted);
            font-size: 10px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN LAYOUT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .main {
            display: flex;
            height: calc(100vh - 56px);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SIDEBAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .sidebar {
            width: 220px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
        }

        .example-group {
            margin-bottom: 8px;
        }

        .example-group-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 10px 4px;
        }

        .example-item {
            padding: 8px 10px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.12s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .example-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .example-item.active {
            background: var(--accent-subtle);
            color: var(--accent);
        }

        .example-icon {
            font-size: 14px;
            width: 20px;
            text-align: center;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           EDITOR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .editor-tabs {
            display: flex;
            align-items: center;
            padding: 0 8px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            height: 36px;
            gap: 2px;
        }

        .editor-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .editor-tab.active {
            color: var(--text-primary);
            background: var(--bg-primary);
            border-bottom-color: var(--accent);
        }

        .tab-icon {
            font-size: 14px;
        }

        .editor-wrapper {
            flex: 1;
            min-height: 0;
        }

        #editor {
            width: 100%;
            height: 100%;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           OUTPUT PANEL
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .output-panel {
            width: 360px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .output-header {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 36px;
        }

        .output-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .status-success {
            background: var(--success-subtle);
            color: var(--success);
        }

        .status-error {
            background: var(--error-subtle);
            color: var(--error);
        }

        .status-running {
            background: var(--accent-subtle);
            color: var(--accent);
        }

        /* Output Panel Tabs */
        .output-tabs {
            display: flex;
            align-items: center;
            padding: 0 8px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            height: 36px;
            gap: 2px;
        }

        .output-tab {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            font-size: 11px;
            color: var(--text-secondary);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.12s ease;
        }

        .output-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .output-tab.active {
            color: var(--text-primary);
            background: var(--bg-primary);
            border-bottom-color: var(--accent);
        }

        .output-tab .tab-icon {
            font-size: 12px;
        }

        .output-tabs .status-badge {
            margin-left: auto;
        }

        /* Transpiler Content */
        .transpiler-content {
            padding: 0 !important;
            display: flex;
            flex-direction: column;
        }

        .transpiler-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .transpiler-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .transpiler-editor {
            flex: 1;
            min-height: 200px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        .output-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .output-section {
            margin-bottom: 16px;
        }

        .output-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .output-text {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px;
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text-primary);
        }

        .output-text.error {
            border-color: var(--error);
            color: var(--error);
            background: var(--error-subtle);
        }

        .output-text.success {
            border-color: var(--success);
        }

        .output-meta {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-muted);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .meta-value {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Welcome State */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 32px;
        }

        .welcome-icon {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.7;
        }

        .welcome-text {
            font-size: 13px;
            line-height: 1.6;
            max-width: 240px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SCROLLBAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SPINNER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--bg-tertiary);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        @media (max-width: 1100px) {
            .sidebar { width: 180px; }
            .output-panel { width: 300px; }
        }

        @media (max-width: 800px) {
            .sidebar { display: none; }
            .output-panel { width: 280px; }
            .logo-badge { display: none; }
        }

        @media (max-width: 600px) {
            .output-panel { 
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 40vh;
                border-left: none;
                border-top: 1px solid var(--border);
            }
            .main {
                flex-direction: column;
                height: calc(100vh - 56px - 40vh);
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           THEME TOGGLE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .theme-toggle {
            position: relative;
        }

        .theme-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 4px;
            min-width: 140px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            display: none;
        }

        .theme-menu.open {
            display: block;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.12s ease;
        }

        .theme-option:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .theme-option.active {
            background: var(--accent-subtle);
            color: var(--accent);
        }

        .theme-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--border);
        }

        .theme-dot.dark { background: #0d1117; }
        .theme-dot.light { background: #ffffff; }
        .theme-dot.monokai { background: #272822; }
        .theme-dot.nord { background: #2e3440; }
    </style>
        <style>
            /* Merge modal styles */
            .modal { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); z-index: 99999; }
            .modal-window.merge-window { width: 96%; max-width: 1200px; background: var(--bg-secondary); border:1px solid var(--border); padding:12px; border-radius:8px; color:var(--text-primary); }
            .merge-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
            .merge-body { display:flex; gap:12px; height: 360px; }
            .merge-side { flex:1; display:flex; flex-direction:column; }
            .merge-center { width: 320px; display:flex; flex-direction:column; gap:8px; }
            .merge-editor { flex:1; border:1px solid var(--border); }
            .merge-merged { height: 180px; border:1px solid var(--border); margin-top:8px; }
            .merge-title { font-weight:600; margin-bottom:6px }
            .hunks-list { overflow:auto; max-height:280px; background:var(--bg-tertiary); padding:6px; border-radius:4px; }
            .hunk-item { border:1px dashed var(--border); padding:6px; margin-bottom:8px; background: linear-gradient(90deg, rgba(0,0,0,0.02), transparent); }
            .hunk-header { display:flex; justify-content:space-between; align-items:center; }
            .hunk-preview { white-space:pre-wrap; font-family: monospace; font-size:12px; color:var(--text-secondary); margin-top:6px; }
            .hunk-actions button { margin-left:6px }
            .hunk-empty { color:var(--text-muted); padding:8px }
            .merge-line-highlight { background: linear-gradient(90deg, rgba(88,166,255,0.06), rgba(88,166,255,0.03)); }
            .merge-gutter { background: var(--accent); width:6px; }
            .conflict-widget { position: absolute; z-index: 1000000; display:flex; gap:6px; }
            .conflict-widget button { padding:6px 8px; border-radius:6px; border:1px solid var(--border); background:var(--bg-secondary); color:var(--text-primary); }
        </style>
</head>
<body data-theme="dark">
    <!-- Retro Splash Screen -->
    <div id="splash">
        <div class="splash-window">
            <div class="splash-titlebar">
                <span class="splash-titlebar-text">realTinyTalkâ„¢</span>
            </div>
            <div class="splash-content">
                <div class="splash-logo">rT</div>
                <div class="splash-title">realTinyTalk</div>
                <div class="splash-version">Version 1.0 â€¢ Build 2026.02</div>
                
                <div class="splash-divider"></div>
                
                <div class="splash-loading">
                    <div class="splash-bar-container">
                        <div class="splash-bar-fill" id="splashProgress"></div>
                    </div>
                    <div class="splash-status" id="splashStatus">Loading...</div>
                </div>
                
                <div class="splash-extensions" id="splashExtensions"></div>
                
                <div class="splash-icon-row">
                    <div class="splash-icon">âš¡</div>
                    <div class="splash-icon">ğŸ“</div>
                    <div class="splash-icon">ğŸ”—</div>
                    <div class="splash-icon">âœ¨</div>
                </div>
                
                <div class="splash-copyright">
                    Â© 2026 Newton Systems<br>
                    The Friendly Programming Language
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">rT</div>
            <span class="logo-text">realTinyTalk</span>
            <span class="logo-badge">Beta</span>
        </div>

        <div class="header-center">
            <div class="select-wrapper">
                <select class="select" id="exampleSelect">
                    <option value="">Load Example...</option>
                </select>
                <span class="select-arrow">â–¼</span>
            </div>
        </div>

        <div class="header-actions">
            <div class="theme-toggle">
                <button class="btn btn-ghost btn-icon-only" id="themeBtn" title="Change Theme">
                    ğŸ¨
                </button>
                <div class="theme-menu" id="themeMenu">
                    <div class="theme-option active" data-theme="dark">
                        <span class="theme-dot dark"></span>
                        Dark
                    </div>
                    <div class="theme-option" data-theme="light">
                        <span class="theme-dot light"></span>
                        Light
                    </div>
                    <div class="theme-option" data-theme="monokai">
                        <span class="theme-dot monokai"></span>
                        Monokai
                    </div>
                    <div class="theme-option" data-theme="nord">
                        <span class="theme-dot nord"></span>
                        Nord
                    </div>
                </div>
            </div>
            <button class="btn" id="saveBtn" onclick="saveCurrent()" title="Save (Ctrl+S)">ğŸ’¾ Save</button>
            <button class="btn" id="saveAsBtn" onclick="saveAs()" title="Save As">ğŸ’¾ Save As</button>
            <button class="btn btn-ghost" id="exportBtn" onclick="exportCurrent()" title="Export current script">â¬‡ï¸ Export</button>
            <button class="btn btn-ghost" id="importBtn" onclick="document.getElementById('fileInput').click()" title="Import script">â¬†ï¸ Import</button>
            <button class="btn btn-ghost" id="saveServerBtn" onclick="saveToServer()" title="Save to server">â˜ï¸ Save</button>
            <button class="btn btn-ghost" id="serverSyncBtn" onclick="openServerList()" title="Sync from server">â˜ï¸ Sync</button>
            <button class="btn btn-ghost" id="loginBtn" onclick="openAuth()" title="Login/Register">ğŸ” Login</button>
            <label style="margin-left:8px;display:inline-flex;align-items:center;gap:6px;" title="Autosave">
                <input type="checkbox" id="autosaveToggle"> Auto
            </label>
            <input type="file" id="fileInput" style="display:none" accept=".tt,.txt" onchange="importFile(event)">
            <button class="btn btn-primary" id="runBtn" onclick="runCode()">
                â–¶ Run
                <kbd>Ctrl+â†µ</kbd>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                ğŸ“š Examples
            </div>
            <div class="sidebar-content" id="examplesList">
                <!-- Loaded dynamically -->
            </div>
        </aside>

        <!-- Editor -->
        <div class="editor-container">
            <div class="editor-tabs">
                <div class="editor-tab active">
                    <span class="tab-icon">ğŸ“„</span>
                    untitled.tt
                </div>
            </div>
            <div class="editor-wrapper">
                <div id="editor"></div>
            </div>
        </div>

        <!-- Output Panel -->
        <aside class="output-panel">
            <div class="output-tabs">
                <div class="output-tab active" data-tab="output" onclick="switchOutputTab('output')">
                    <span class="tab-icon">ğŸ“¤</span> Output
                </div>
                <div class="output-tab" data-tab="javascript" onclick="switchOutputTab('javascript')">
                    <span class="tab-icon">ğŸŸ¨</span> JavaScript
                </div>
                <div class="output-tab" data-tab="python" onclick="switchOutputTab('python')">
                    <span class="tab-icon">ğŸ</span> Python
                </div>
                <span class="status-badge" id="statusBadge"></span>
            </div>
            
            <!-- Output Content -->
            <div class="output-content" id="outputContent">
                <div class="welcome">
                    <div class="welcome-icon">âœ¨</div>
                    <div class="welcome-text">
                        Write code and press <kbd>Ctrl+Enter</kbd> to run
                    </div>
                </div>
            </div>
            
            <!-- JavaScript Transpiled Code -->
            <div class="output-content transpiler-content" id="jsContent" style="display: none;">
                <div class="transpiler-header">
                    <span class="transpiler-title">Transpiled JavaScript</span>
                    <button class="btn btn-ghost btn-sm" onclick="copyCode('js')">ğŸ“‹ Copy</button>
                </div>
                <div id="jsEditor" class="transpiler-editor"></div>
            </div>
            
            <!-- Python Transpiled Code -->
            <div class="output-content transpiler-content" id="pyContent" style="display: none;">
                <div class="transpiler-header">
                    <span class="transpiler-title">Transpiled Python</span>
                    <button class="btn btn-ghost btn-sm" onclick="copyCode('py')">ğŸ“‹ Copy</button>
                </div>
                <div id="pyEditor" class="transpiler-editor"></div>
            </div>
        </aside>
    </main>

    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <!-- jsdiff for visual diffs and hunk operations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff/5.1.0/diff.min.js"></script>
    <script>
        let editor;
        let examples = [];
        let currentTheme = localStorage.getItem('tinytalk-theme') || 'dark';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RETRO SPLASH SCREEN (5 second minimum)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const splashStartTime = Date.now();
        const MINIMUM_SPLASH_TIME = 5000; // Show splash for 5 seconds
        
        const loadingExtensions = [
            'Monaco Editor',
            'Syntax Highlighter',
            'TinyTalk Language',
            'Step Chains',
            'Property Magic',
            'Blueprints',
            'Verified Runtime',
            'Examples Library'
        ];
        let currentExtIndex = 0;
        
        function updateSplash(progress, status) {
            const bar = document.getElementById('splashProgress');
            const text = document.getElementById('splashStatus');
            if (bar) bar.style.width = progress + '%';
            if (text) text.textContent = status;
        }
        
        function showExtension(name) {
            const container = document.getElementById('splashExtensions');
            if (container) {
                container.innerHTML = `<span class="splash-ext-item">Loading: ${name}</span>`;
            }
        }
        
        // Cycle through extensions during load
        function cycleExtensions() {
            if (currentExtIndex < loadingExtensions.length) {
                const ext = loadingExtensions[currentExtIndex];
                showExtension(ext);
                const progress = 10 + (currentExtIndex / loadingExtensions.length) * 80;
                updateSplash(progress, `Initializing...`);
                currentExtIndex++;
                setTimeout(cycleExtensions, 500);
            }
        }
        
        function hideSplash() {
            const elapsed = Date.now() - splashStartTime;
            const remaining = Math.max(0, MINIMUM_SPLASH_TIME - elapsed);
            
            // Wait for minimum time, then fade out
            setTimeout(() => {
                updateSplash(100, 'Ready!');
                showExtension('Complete');
                setTimeout(() => {
                    const splash = document.getElementById('splash');
                    if (splash) {
                        splash.classList.add('hidden');
                        setTimeout(() => splash.remove(), 800);
                    }
                }, 600);
            }, remaining);
        }
        
        updateSplash(5, 'Starting...');
        setTimeout(cycleExtensions, 300);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // THEME MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function setTheme(theme) {
            currentTheme = theme;
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('tinytalk-theme', theme);
            
            // Update Monaco theme
            const monacoTheme = 'tinytalk-' + theme;
            if (editor) {
                monaco.editor.setTheme(monacoTheme);
            }
            // Also update transpiler editors
            if (typeof jsEditor !== 'undefined' && jsEditor) {
                monaco.editor.setTheme(monacoTheme);
            }
            if (typeof pyEditor !== 'undefined' && pyEditor) {
                monaco.editor.setTheme(monacoTheme);
            }
            
            // Update theme menu
            document.querySelectorAll('.theme-option').forEach(el => {
                el.classList.toggle('active', el.dataset.theme === theme);
            });
        }

        // Initialize theme
        document.body.setAttribute('data-theme', currentTheme);

        // Theme toggle button
        document.getElementById('themeBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('themeMenu').classList.toggle('open');
        });

        // Theme options
        document.querySelectorAll('.theme-option').forEach(el => {
            el.addEventListener('click', () => {
                setTheme(el.dataset.theme);
                document.getElementById('themeMenu').classList.remove('open');
            });
        });

        // Close menu on outside click
        document.addEventListener('click', () => {
            document.getElementById('themeMenu').classList.remove('open');
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MONACO EDITOR SETUP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
        
        updateSplash(20, 'Configuring editor...');
        
        require(['vs/editor/editor.main'], function () {
            updateSplash(40, 'Registering TinyTalk language...');
            
            // Register TinyTalk language
            monaco.languages.register({ id: 'tinytalk' });

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COMPLETE TINYTALK LANGUAGE DEFINITION
            // Synced with lexer.py + stdlib.py + runtime.py (Feb 2026)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            monaco.languages.setMonarchTokensProvider('tinytalk', {
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // THE SACRED KEYWORDS (tinyTalk Bible)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                keywords: [
                    // The Five Sacred Words
                    'when', 'and', 'fin', 'finfr', 'ratio',
                    // Layer 0: Governance
                    'blueprint', 'law',
                    // Layer 1: Executive
                    'field', 'forge', 'reply', 'do', 'fin_then', 'end',
                    // General Keywords
                    'let', 'const', 'fn', 'return', 'if', 'else', 'elif',
                    'for', 'while', 'in', 'break', 'continue', 'match', 'case',
                    'type', 'struct', 'enum', 'impl', 'trait',
                    'import', 'export', 'from', 'as', 'pub', 'mut',
                    'async', 'await', 'try', 'catch', 'throw',
                    // Type keywords
                    'int', 'float', 'str', 'bool', 'list', 'map', 'any', 'void',
                    // Matter Types (Units)
                    'money', 'mass', 'distance', 'temperature', 'pressure',
                    'velocity', 'time', 'volume',
                    // Logical
                    'or', 'not'
                ],
                
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // NATURAL COMPARISON KEYWORDS (reads like English)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                comparisons: [
                    'is', 'isnt', 'has', 'hasnt', 'isin', 'islike'
                ],
                
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // CONSTANTS
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                constants: [
                    'true', 'false', 'null', 'nil',
                    'PI', 'E', 'TAU', 'INF', 'NAN'
                ],
                
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // STDLIB BUILTINS (from stdlib.py)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                builtins: [
                    // Output
                    'show', 'print', 'println',
                    // Input
                    'input',
                    // Types
                    'len', 'type', 'typeof',
                    // Collections
                    'range', 'append', 'push', 'pop', 'keys', 'values',
                    'contains', 'slice', 'reverse', 'sort',
                    // Higher-order
                    'filter', 'map_', 'reduce', 'zip', 'enumerate',
                    // Strings
                    'split', 'join',
                    // Math
                    'sum', 'min', 'max', 'abs', 'round', 'floor', 'ceil',
                    'sqrt', 'pow', 'sin', 'cos', 'tan', 'log', 'exp',
                    // Utility
                    'assert', 'assert_equal', 'assert_true', 'assert_false',
                    'assert_throws', 'hash'
                ],
                
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // STEP OPERATIONS (dplyr-style data chaining)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                steps: [
                    '_filter', '_sort', '_map', '_take', '_drop',
                    '_first', '_last', '_reverse', '_unique', '_count',
                    '_sum', '_avg', '_min', '_max', '_group',
                    '_flatten', '_zip', '_chunk'
                ],
                
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // PROPERTY MAGIC (from runtime.py - no parens needed!)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                properties: [
                    // Universal
                    'len', 'str', 'int', 'float', 'bool', 'type',
                    // String magic
                    'upper', 'upcase', 'lower', 'lowcase', 'trim',
                    'chars', 'words', 'lines', 'reversed', 'length',
                    // List magic
                    'first', 'last', 'empty'
                ],
                
                operators: [
                    '=', '==', '!=', '~~', '<', '>', '<=', '>=',
                    '+', '-', '*', '/', '//', '%', '**',
                    '|>', ':=', '->', '=>', '..', '..=', '::',
                    '&', '|', '^', '~', '<<', '>>'
                ],
                symbols: /[=><!~?:&|+\-*\/\^%]+/,

                tokenizer: {
                    root: [
                        // Comments
                        [/\/\/.*$/, 'comment'],
                        [/#.*$/, 'comment'],
                        [/\/\*/, 'comment', '@comment'],

                        // Strings
                        [/"([^"\\]|\\.)*$/, 'string.invalid'],
                        [/"/, 'string', '@string_double'],
                        [/'([^'\\]|\\.)*$/, 'string.invalid'],
                        [/'/, 'string', '@string_single'],

                        // Numbers
                        [/\d+\.\d+([eE][\-+]?\d+)?/, 'number.float'],
                        [/0[xX][0-9a-fA-F]+/, 'number.hex'],
                        [/0[bB][01]+/, 'number.binary'],
                        [/\d+/, 'number'],

                        // Step operations (underscore-prefixed) - IMPORTANT!
                        [/_[a-zA-Z]\w*/, {
                            cases: {
                                '@steps': 'keyword.step',
                                '@default': 'identifier'
                            }
                        }],

                        // Property access with dot (property magic)
                        [/\.([a-zA-Z]\w*)/, {
                            cases: {
                                '$1@properties': 'variable.property.magic',
                                '@default': 'variable.property'
                            }
                        }],

                        // Identifiers
                        [/[a-zA-Z_]\w*/, {
                            cases: {
                                '@keywords': 'keyword',
                                '@comparisons': 'keyword.comparison',
                                '@constants': 'constant',
                                '@builtins': 'predefined',
                                '@default': 'identifier'
                            }
                        }],

                        // Operators
                        [/@symbols/, {
                            cases: {
                                '@operators': 'operator',
                                '@default': ''
                            }
                        }],

                        // Brackets
                        [/[{}()\[\]]/, '@brackets'],
                        [/[,;]/, 'delimiter'],
                    ],

                    comment: [
                        [/[^/*]+/, 'comment'],
                        [/\*\//, 'comment', '@pop'],
                        [/[/*]/, 'comment']
                    ],

                    string_double: [
                        [/[^\\"]+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/"/, 'string', '@pop']
                    ],

                    string_single: [
                        [/[^\\']+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/'/, 'string', '@pop']
                    ]
                }
            });

            // Define themes with CONSISTENT, BEAUTIFUL colors
            
            // Dark theme (GitHub Dark)
            monaco.editor.defineTheme('tinytalk-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    // Keywords
                    { token: 'keyword', foreground: 'ff7b72', fontStyle: 'bold' },
                    { token: 'keyword.comparison', foreground: 'ff7b72', fontStyle: 'bold italic' },
                    { token: 'keyword.step', foreground: 'd2a8ff', fontStyle: 'italic' },
                    // Constants & Builtins
                    { token: 'constant', foreground: '79c0ff', fontStyle: 'bold' },
                    { token: 'predefined', foreground: 'd2a8ff' },
                    // Literals
                    { token: 'string', foreground: 'a5d6ff' },
                    { token: 'string.escape', foreground: '79c0ff' },
                    { token: 'number', foreground: '79c0ff' },
                    { token: 'number.float', foreground: '79c0ff' },
                    { token: 'number.hex', foreground: '79c0ff' },
                    { token: 'number.binary', foreground: '79c0ff' },
                    // Comments
                    { token: 'comment', foreground: '8b949e', fontStyle: 'italic' },
                    // Operators & Identifiers
                    { token: 'operator', foreground: 'ff7b72' },
                    { token: 'identifier', foreground: 'e6edf3' },
                    // Properties - key differentiator!
                    { token: 'variable.property', foreground: '7ee787' },
                    { token: 'variable.property.magic', foreground: 'ffa657', fontStyle: 'italic' },
                    { token: 'delimiter', foreground: '8b949e' },
                ],
                colors: {
                    'editor.background': '#0d1117',
                    'editor.foreground': '#e6edf3',
                    'editor.lineHighlightBackground': '#161b22',
                    'editor.selectionBackground': '#264f78',
                    'editorCursor.foreground': '#58a6ff',
                    'editorLineNumber.foreground': '#6e7681',
                    'editorLineNumber.activeForeground': '#e6edf3',
                    'editor.inactiveSelectionBackground': '#264f7855',
                }
            });

            // Light theme (GitHub Light)
            monaco.editor.defineTheme('tinytalk-light', {
                base: 'vs',
                inherit: true,
                rules: [
                    { token: 'keyword', foreground: 'cf222e', fontStyle: 'bold' },
                    { token: 'keyword.comparison', foreground: 'cf222e', fontStyle: 'bold italic' },
                    { token: 'keyword.step', foreground: '8250df', fontStyle: 'italic' },
                    { token: 'constant', foreground: '0550ae', fontStyle: 'bold' },
                    { token: 'predefined', foreground: '8250df' },
                    { token: 'string', foreground: '0a3069' },
                    { token: 'string.escape', foreground: '0550ae' },
                    { token: 'number', foreground: '0550ae' },
                    { token: 'number.float', foreground: '0550ae' },
                    { token: 'number.hex', foreground: '0550ae' },
                    { token: 'number.binary', foreground: '0550ae' },
                    { token: 'comment', foreground: '6e7781', fontStyle: 'italic' },
                    { token: 'operator', foreground: 'cf222e' },
                    { token: 'identifier', foreground: '1f2328' },
                    { token: 'variable.property', foreground: '116329' },
                    { token: 'variable.property.magic', foreground: '953800', fontStyle: 'italic' },
                ],
                colors: {
                    'editor.background': '#ffffff',
                    'editor.foreground': '#1f2328',
                    'editor.lineHighlightBackground': '#f6f8fa',
                    'editor.selectionBackground': '#add6ff',
                    'editorCursor.foreground': '#0969da',
                    'editorLineNumber.foreground': '#8b949e',
                    'editorLineNumber.activeForeground': '#1f2328',
                }
            });

            // Monokai theme
            monaco.editor.defineTheme('tinytalk-monokai', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'keyword', foreground: 'f92672', fontStyle: 'bold' },
                    { token: 'keyword.comparison', foreground: 'f92672', fontStyle: 'bold italic' },
                    { token: 'keyword.step', foreground: '66d9ef', fontStyle: 'italic' },
                    { token: 'constant', foreground: 'ae81ff', fontStyle: 'bold' },
                    { token: 'predefined', foreground: 'a6e22e' },
                    { token: 'string', foreground: 'e6db74' },
                    { token: 'string.escape', foreground: 'ae81ff' },
                    { token: 'number', foreground: 'ae81ff' },
                    { token: 'number.float', foreground: 'ae81ff' },
                    { token: 'number.hex', foreground: 'ae81ff' },
                    { token: 'number.binary', foreground: 'ae81ff' },
                    { token: 'comment', foreground: '75715e', fontStyle: 'italic' },
                    { token: 'operator', foreground: 'f92672' },
                    { token: 'identifier', foreground: 'f8f8f2' },
                    { token: 'variable.property', foreground: 'a6e22e' },
                    { token: 'variable.property.magic', foreground: 'fd971f', fontStyle: 'italic' },
                ],
                colors: {
                    'editor.background': '#272822',
                    'editor.foreground': '#f8f8f2',
                    'editor.lineHighlightBackground': '#3e3d32',
                    'editor.selectionBackground': '#49483e',
                    'editorCursor.foreground': '#f8f8f0',
                    'editorLineNumber.foreground': '#90908a',
                    'editorLineNumber.activeForeground': '#c2c2bf',
                }
            });

            // Nord theme
            monaco.editor.defineTheme('tinytalk-nord', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'keyword', foreground: '81a1c1', fontStyle: 'bold' },
                    { token: 'keyword.comparison', foreground: '81a1c1', fontStyle: 'bold italic' },
                    { token: 'keyword.step', foreground: '88c0d0', fontStyle: 'italic' },
                    { token: 'constant', foreground: 'b48ead', fontStyle: 'bold' },
                    { token: 'predefined', foreground: '88c0d0' },
                    { token: 'string', foreground: 'a3be8c' },
                    { token: 'string.escape', foreground: 'ebcb8b' },
                    { token: 'number', foreground: 'b48ead' },
                    { token: 'number.float', foreground: 'b48ead' },
                    { token: 'number.hex', foreground: 'b48ead' },
                    { token: 'number.binary', foreground: 'b48ead' },
                    { token: 'comment', foreground: '616e88', fontStyle: 'italic' },
                    { token: 'operator', foreground: '81a1c1' },
                    { token: 'identifier', foreground: 'eceff4' },
                    { token: 'variable.property', foreground: '8fbcbb' },
                    { token: 'variable.property.magic', foreground: 'd08770', fontStyle: 'italic' },
                ],
                colors: {
                    'editor.background': '#2e3440',
                    'editor.foreground': '#eceff4',
                    'editor.lineHighlightBackground': '#3b4252',
                    'editor.selectionBackground': '#434c5e',
                    'editorCursor.foreground': '#88c0d0',
                    'editorLineNumber.foreground': '#4c566a',
                    'editorLineNumber.activeForeground': '#d8dee9',
                }
            });

            updateSplash(60, 'Creating editor instance...');

            // Create editor
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: `// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Welcome to realTinyTalk!
// The friendliest programming language
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show("Hello World!")

// Variables with let
let name = "Newton"
let nums = [5, 2, 8, 1, 9]

// show() - space-separated args (no commas needed!)
show("Hello" name "!")
show("Numbers:" nums)

// Step chains - dplyr-style data manipulation
show("")
show("=== Step Chains ===")
show("Sorted:" nums _sort)
show("Sum:" nums _sum)
show("Top 3:" nums _sort _reverse _take(3))

// Natural comparisons - reads like English!
show("")
show("=== Natural Comparisons ===")
show("5 is 5:" (5 is 5))
show("nums has 5:" (nums has 5))
show("name islike N*:" (name islike "N*"))

// Property magic - no function calls!
show("")
show("=== Property Magic ===")
show("name.upcase:" name.upcase)
show("name.len:" name.len)
show("name.reversed:" name.reversed)
show("name.chars:" name.chars)

// Pure functions with law
law fib(n)
    if n <= 1 { reply n }
    reply fib(n - 1) + fib(n - 2)
end

show("")
show("=== Fibonacci ===")
for i in range(10) {
    show("fib(" i.str ") =" fib(i))
}
`,
                language: 'tinytalk',
                theme: 'tinytalk-' + currentTheme,
                fontFamily: "'JetBrains Mono', 'Fira Code', Consolas, monospace",
                fontSize: 14,
                lineHeight: 22,
                padding: { top: 12, bottom: 12 },
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                renderLineHighlight: 'all',
                cursorBlinking: 'smooth',
                smoothScrolling: true,
                tabSize: 4,
                insertSpaces: true,
                automaticLayout: true,
                bracketPairColorization: { enabled: true },
                guides: {
                    bracketPairs: true,
                    indentation: true,
                },
            });

            // Ctrl+Enter to run
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runCode);

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // AUTO-COMPLETION - Full Language Support
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            monaco.languages.registerCompletionItemProvider('tinytalk', {
                provideCompletionItems: () => {
                    const suggestions = [
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Sacred Keywords
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        ...['when', 'and', 'fin', 'finfr', 'ratio', 'do', 'fin_then'].map(k => ({
                            label: k,
                            kind: monaco.languages.CompletionItemKind.Keyword,
                            insertText: k,
                            documentation: 'Sacred keyword (TinyTalk Bible)'
                        })),
                        
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Governance Keywords
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        ...['blueprint', 'law', 'field', 'forge', 'reply', 'end'].map(k => ({
                            label: k,
                            kind: monaco.languages.CompletionItemKind.Keyword,
                            insertText: k,
                            documentation: 'Governance/Executive keyword'
                        })),
                        
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Control Flow
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        ...['let', 'const', 'if', 'else', 'elif', 'for', 'while', 'in', 
                            'return', 'break', 'continue', 'fn', 'match', 'case'].map(k => ({
                            label: k,
                            kind: monaco.languages.CompletionItemKind.Keyword,
                            insertText: k,
                        })),
                        
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Natural Comparisons (reads like English!)
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        { label: 'is', kind: monaco.languages.CompletionItemKind.Operator, 
                          insertText: 'is', documentation: 'Natural equality: x is 5' },
                        { label: 'isnt', kind: monaco.languages.CompletionItemKind.Operator, 
                          insertText: 'isnt', documentation: 'Natural not-equal: x isnt 5' },
                        { label: 'has', kind: monaco.languages.CompletionItemKind.Operator, 
                          insertText: 'has', documentation: 'Contains check: list has 5' },
                        { label: 'hasnt', kind: monaco.languages.CompletionItemKind.Operator, 
                          insertText: 'hasnt', documentation: 'Not contains: list hasnt 5' },
                        { label: 'isin', kind: monaco.languages.CompletionItemKind.Operator, 
                          insertText: 'isin', documentation: 'Element of: x isin list' },
                        { label: 'islike', kind: monaco.languages.CompletionItemKind.Operator, 
                          insertText: 'islike', documentation: 'Pattern match: name islike "N*"' },
                        
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Constants
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        ...['true', 'false', 'null', 'nil', 'PI', 'E', 'TAU', 'INF'].map(c => ({
                            label: c,
                            kind: monaco.languages.CompletionItemKind.Constant,
                            insertText: c,
                        })),
                        
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Builtins (from stdlib.py)
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        ...['show', 'print', 'println', 'input'].map(b => ({
                            label: b,
                            kind: monaco.languages.CompletionItemKind.Function,
                            insertText: b,
                            documentation: 'I/O function'
                        })),
                        ...['len', 'type', 'typeof', 'str', 'int', 'float', 'bool', 'list', 'map'].map(b => ({
                            label: b,
                            kind: monaco.languages.CompletionItemKind.Function,
                            insertText: b,
                            documentation: 'Type conversion/inspection'
                        })),
                        ...['range', 'append', 'push', 'pop', 'keys', 'values', 'contains', 
                            'slice', 'reverse', 'sort', 'filter', 'zip', 'enumerate'].map(b => ({
                            label: b,
                            kind: monaco.languages.CompletionItemKind.Function,
                            insertText: b,
                            documentation: 'Collection function'
                        })),
                        ...['sum', 'min', 'max', 'abs', 'round', 'floor', 'ceil',
                            'sqrt', 'pow', 'sin', 'cos', 'tan', 'log', 'exp'].map(b => ({
                            label: b,
                            kind: monaco.languages.CompletionItemKind.Function,
                            insertText: b,
                            documentation: 'Math function'
                        })),
                        ...['split', 'join', 'hash'].map(b => ({
                            label: b,
                            kind: monaco.languages.CompletionItemKind.Function,
                            insertText: b,
                        })),
                        
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Step Operations (dplyr-style chaining)
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        ...['_filter', '_sort', '_map', '_take', '_drop', '_first', '_last',
                            '_reverse', '_unique', '_count', '_sum', '_avg', '_min', '_max',
                            '_group', '_flatten', '_zip', '_chunk'].map(s => ({
                            label: s,
                            kind: monaco.languages.CompletionItemKind.Method,
                            insertText: s,
                            documentation: 'Step operation for data chaining: list ' + s,
                        })),
                        
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Property Magic (no parens needed!)
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        ...[ 
                            { prop: '.str', doc: 'Convert to string' },
                            { prop: '.int', doc: 'Convert to integer' },
                            { prop: '.float', doc: 'Convert to float' },
                            { prop: '.bool', doc: 'Convert to boolean' },
                            { prop: '.len', doc: 'Get length' },
                            { prop: '.type', doc: 'Get type name' },
                            { prop: '.upcase', doc: 'String to UPPERCASE' },
                            { prop: '.lowcase', doc: 'String to lowercase' },
                            { prop: '.trim', doc: 'Strip whitespace' },
                            { prop: '.chars', doc: 'String to char list' },
                            { prop: '.words', doc: 'Split into words' },
                            { prop: '.lines', doc: 'Split into lines' },
                            { prop: '.reversed', doc: 'Reverse string/list' },
                            { prop: '.first', doc: 'First element of list' },
                            { prop: '.last', doc: 'Last element of list' },
                            { prop: '.empty', doc: 'Check if list is empty' },
                        ].map(p => ({
                            label: p.prop,
                            kind: monaco.languages.CompletionItemKind.Property,
                            insertText: p.prop,
                            documentation: p.doc + ' (no parens needed!)'
                        })),
                        
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Snippets
                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        {
                            label: 'law',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'law ${1:name}(${2:args})\n\t$0\n\treply ${3:result}\nend',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Define a pure function (law)'
                        },
                        {
                            label: 'when',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'when ${1:name}(${2:x})\n\tdo ${3:x * 2}\nfinfr',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Define a function (sacred syntax)'
                        },
                        {
                            label: 'blueprint',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'blueprint ${1:Name}\n\tfield ${2:x}\n\t\n\tforge ${3:method}()\n\t\t$0\n\t\treply self.${2:x}\n\tend\nend',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'Define a class (blueprint)'
                        },
                        {
                            label: 'for',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'for ${1:i} in ${2:range(10)} {\n\t$0\n}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'For loop'
                        },
                        {
                            label: 'if',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'if ${1:condition} {\n\t$0\n}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'If statement'
                        },
                        {
                            label: 'ifelse',
                            kind: monaco.languages.CompletionItemKind.Snippet,
                            insertText: 'if ${1:condition} {\n\t$2\n} else {\n\t$0\n}',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            documentation: 'If-else statement'
                        },
                    ];
                    return { suggestions };
                }
            });
            
            updateSplash(80, 'Loading examples...');
            
            // Load examples then hide splash
            loadExamples().then(() => {
                updateSplash(95, 'Almost ready...');
                hideSplash();
            });
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXAMPLES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadExamples() {
            try {
                const response = await fetch('/api/examples');
                examples = await response.json();
                
                // Populate sidebar
                const list = document.getElementById('examplesList');
                list.innerHTML = examples.map((ex, i) => `
                    <div class="example-item" onclick="loadExample(${i})">
                        <span class="example-icon">${ex.name.split(' ')[0]}</span>
                        <span>${ex.name.slice(ex.name.indexOf(' ') + 1)}</span>
                    </div>
                `).join('');

                // Populate dropdown
                const select = document.getElementById('exampleSelect');
                select.innerHTML = '<option value="">Load Example...</option>' +
                    examples.map((ex, i) => `<option value="${i}">${ex.name}</option>`).join('');
            } catch (err) {
                console.error('Failed to load examples:', err);
            }
        }

        function loadExample(index) {
            const example = examples[index];
            if (example && editor) {
                editor.setValue(example.code);
                document.querySelectorAll('.example-item').forEach((el, i) => {
                    el.classList.toggle('active', i === index);
                });
                document.getElementById('exampleSelect').value = index;
            }
        }

        document.getElementById('exampleSelect').addEventListener('change', (e) => {
            if (e.target.value !== '') {
                loadExample(parseInt(e.target.value));
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TRANSPILER EDITORS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let jsEditor = null;
        let pyEditor = null;
        let currentOutputTab = 'output';
        
        function getMonacoTheme(themeName) {
            const themeMap = {
                'dark': 'tinytalk-dark',
                'light': 'tinytalk-light',
                'monokai': 'tinytalk-monokai',
                'nord': 'tinytalk-nord'
            };
            return themeMap[themeName] || 'tinytalk-dark';
        }
        
        // Deferred editor creation - create when tab is first shown
        function ensureJsEditor() {
            if (!jsEditor) {
                jsEditor = monaco.editor.create(document.getElementById('jsEditor'), {
                    value: '// JavaScript output will appear here after running code',
                    language: 'javascript',
                    theme: getMonacoTheme(currentTheme),
                    readOnly: true,
                    minimap: { enabled: false },
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    fontSize: 13,
                    fontFamily: "'JetBrains Mono', monospace",
                    automaticLayout: true,
                    wordWrap: 'on'
                });
            }
            return jsEditor;
        }
        
        function ensurePyEditor() {
            if (!pyEditor) {
                pyEditor = monaco.editor.create(document.getElementById('pyEditor'), {
                    value: '# Python output will appear here after running code',
                    language: 'python',
                    theme: getMonacoTheme(currentTheme),
                    readOnly: true,
                    minimap: { enabled: false },
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    fontSize: 13,
                    fontFamily: "'JetBrains Mono', monospace",
                    automaticLayout: true,
                    wordWrap: 'on'
                });
            }
            return pyEditor;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOCAL SAVE / LOAD / AUTOSAVE / EXPORT / IMPORT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const STORAGE_KEY = 'tinytalk-scripts';
        let scripts = {};
        let activeScript = 'untitled.tt';
        let autosaveInterval = null;
        const AUTOSAVE_MS = 5000;

        function loadScriptsFromStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                scripts = raw ? JSON.parse(raw) : {};
            } catch (e) {
                console.warn('Failed to parse stored scripts', e);
                scripts = {};
            }
            if (!scripts[activeScript]) {
                scripts[activeScript] = editor ? editor.getValue() : '';
            }
            refreshTabs();
        }

        function saveAllToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(scripts));
        }

        function showStatus(msg) {
            const el = document.getElementById('statusBadge');
            if (!el) return;
            el.textContent = msg;
            clearTimeout(el._t);
            el._t = setTimeout(() => { if (el.textContent === msg) el.textContent = ''; }, 2002);
        }

        function getActiveTabName() {
            const el = document.querySelector('.editor-tab.active');
            return el ? el.textContent.trim() : activeScript;
        }

        function setActiveTab(name) {
            activeScript = name;
            const tabs = document.querySelector('.editor-tabs');
            let existing = Array.from(tabs.querySelectorAll('.editor-tab')).find(t => t.textContent.trim() === name);
            if (!existing) {
                const div = document.createElement('div');
                div.className = 'editor-tab';
                div.innerHTML = `<span class="tab-icon">ğŸ“„</span>${name}`;
                div.addEventListener('click', () => setActiveTab(name));
                tabs.appendChild(div);
                existing = div;
            }
            document.querySelectorAll('.editor-tab').forEach(t => t.classList.toggle('active', t === existing));
            if (editor) editor.setValue(scripts[name] || '');
        }

        function refreshTabs() {
            const tabs = document.querySelector('.editor-tabs');
            tabs.innerHTML = '';
            const keys = Object.keys(scripts);
            if (keys.length === 0) {
                scripts['untitled.tt'] = editor ? editor.getValue() : '';
            }
            keys.forEach((k) => {
                const div = document.createElement('div');
                div.className = 'editor-tab' + (k === activeScript ? ' active' : '');
                div.innerHTML = `<span class="tab-icon">ğŸ“„</span>${k}`;
                div.addEventListener('click', () => setActiveTab(k));
                tabs.appendChild(div);
            });
        }

        function saveCurrent() {
            const name = getActiveTabName() || activeScript;
            scripts[name] = editor.getValue();
            saveAllToStorage();
            showStatus('Saved ' + name);
            refreshTabs();
        }

        function saveAs() {
            const defaultName = getActiveTabName() || activeScript || 'untitled.tt';
            const name = prompt('Save as filename', defaultName);
            if (!name) return;
            scripts[name] = editor.getValue();
            setActiveTab(name);
            saveAllToStorage();
            showStatus('Saved as ' + name);
        }

        function exportCurrent() {
            const name = getActiveTabName() || activeScript || 'script.tt';
            const blob = new Blob([editor.getValue()], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            showStatus('Exported ' + name);
        }

        function importFile(evt) {
            const file = evt.target.files && evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const name = file.name || 'imported.tt';
                scripts[name] = content;
                setActiveTab(name);
                saveAllToStorage();
                showStatus('Imported ' + name);
            };
            reader.readAsText(file);
            evt.target.value = '';
        }

        function startAutosave() {
            if (autosaveInterval) clearInterval(autosaveInterval);
            autosaveInterval = setInterval(() => {
                if (document.getElementById('autosaveToggle') && document.getElementById('autosaveToggle').checked) {
                    scripts[getActiveTabName()] = editor.getValue();
                    saveAllToStorage();
                    showStatus('Autosaved ' + getActiveTabName());
                }
            }, AUTOSAVE_MS);
        }

        // Keyboard shortcut for Save (Ctrl+S)
        window.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
                e.preventDefault();
                saveCurrent();
            }
        });

        // Initialize storage after editor created
        setTimeout(() => {
            if (typeof editor !== 'undefined' && editor) {
                // Ensure starting content is saved under activeScript
                scripts[activeScript] = editor.getValue();
                loadScriptsFromStorage();
                startAutosave();
            }
        }, 200);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SERVER SYNC / HISTORY / RENAME / CLOSE / REORDER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function saveToServer() {
            const name = getActiveTabName() || activeScript;
            const code = editor.getValue();

            // Check remote for conflict
            const resp = await fetch(`/api/scripts/${encodeURIComponent(name)}`);
            if (resp.ok) {
                const remote = await resp.json();
                if (remote.content && remote.content !== code) {
                    // Open merge UI to let user resolve conflict
                    openMergePanel(name, remote.content, code);
                    return;
                }
            }

            const r = await fetch('/api/scripts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, code, message: 'saved from web UI' })
            });
            if (r.ok) {
                const data = await r.json();
                showStatus('Saved to server ' + data.name);
            } else {
                showStatus('Server save failed');
            }
        }

        async function openServerList() {
            try {
                const r = await fetch('/api/scripts');
                const list = await r.json();
                const pick = prompt('Server scripts:\n' + list.map(s => s.name).join('\n') + '\n\nEnter name to load:');
                if (!pick) return;
                const rr = await fetch(`/api/scripts/${encodeURIComponent(pick)}`);
                if (!rr.ok) { showStatus('Failed to load ' + pick); return; }
                const payload = await rr.json();
                scripts[pick] = payload.content;
                setActiveTab(pick);
                saveAllToStorage();
                showStatus('Loaded ' + pick);
            } catch (e) {
                console.error(e);
                showStatus('Server sync failed');
            }
        }

        // History modal (simple)
        function showHistory() {
            const name = getActiveTabName();
            if (!name) return alert('No active script');
            fetch(`/api/scripts/${encodeURIComponent(name)}`).then(r => r.json()).then(payload => {
                const versions = payload.versions || [];
                const list = versions.map(v => `${v.ts} - ${v.message || ''} [${v.id.slice(0,7)}]`).join('\n');
                const pick = prompt('Versions for ' + name + ':\n' + list + '\n\nEnter version id (prefix ok) to restore:');
                if (!pick) return;
                const found = versions.find(v => v.id.startsWith(pick));
                if (!found) return alert('Version not found');
                // restore
                fetch(`/api/scripts/${encodeURIComponent(name)}/restore`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ version_id: found.id })
                }).then(r => r.json()).then(res => {
                    showStatus('Restored ' + name);
                });
            });
        }

        // Tab utilities: rename, close, reorder via drag
        function makeTabElement(name) {
            const div = document.createElement('div');
            div.className = 'editor-tab';
            div.draggable = true;
            div.innerHTML = `<span class="tab-icon">ğŸ“„</span><span class="tab-text">${name}</span><span class="tab-close">âœ–</span>`;
            div.querySelector('.tab-text').addEventListener('dblclick', () => {
                const newName = prompt('Rename file', name);
                if (!newName) return;
                // move in scripts
                scripts[newName] = scripts[name];
                delete scripts[name];
                setActiveTab(newName);
                saveAllToStorage();
                showStatus('Renamed to ' + newName);
            });
            div.querySelector('.tab-close').addEventListener('click', (e) => {
                e.stopPropagation();
                if (!confirm('Close tab ' + name + '?')) return;
                delete scripts[name];
                saveAllToStorage();
                refreshTabs();
                const remaining = Object.keys(scripts)[0];
                if (remaining) setActiveTab(remaining);
                else {
                    editor.setValue('');
                }
            });
            div.addEventListener('click', () => setActiveTab(name));
            div.addEventListener('dragstart', (ev) => { ev.dataTransfer.setData('text/tab', name); });
            div.addEventListener('dragover', (ev) => ev.preventDefault());
            div.addEventListener('drop', (ev) => {
                ev.preventDefault();
                const src = ev.dataTransfer.getData('text/tab');
                const dst = name;
                if (src === dst) return;
                // reorder keys: create new object with order
                const keys = Object.keys(scripts);
                const newKeys = [];
                for (const k of keys) {
                    if (k === src) continue;
                    if (k === dst) {
                        newKeys.push(src);
                    }
                    newKeys.push(k);
                }
                // rebuild scripts object
                const newScripts = {};
                for (const k of newKeys) { newScripts[k] = scripts[k]; }
                scripts = newScripts;
                refreshTabs();
                showStatus('Reordered');
            });
            return div;
        }

        // small helper to refreshTabs using makeTabElement so close/rename exist
        function refreshTabs() {
            const tabs = document.querySelector('.editor-tabs');
            tabs.innerHTML = '';
            const keys = Object.keys(scripts);
            if (keys.length === 0) {
                scripts['untitled.tt'] = editor ? editor.getValue() : '';
            }
            keys.forEach((k) => {
                const el = makeTabElement(k);
                if (k === activeScript) el.classList.add('active');
                tabs.appendChild(el);
            });
        }

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // AUTH MODAL
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                function openAuth() {
                        const html = `
                        <div class="modal" id="authModal">
                            <div class="modal-window">
                                <h3>Login / Register</h3>
                                <div style="display:flex;gap:8px;margin-top:8px">
                                    <input id="authUser" placeholder="username" />
                                    <input id="authPass" placeholder="password" type="password" />
                                </div>
                                <div style="margin-top:12px;display:flex;gap:8px">
                                    <button onclick="doLogin()" class="btn">Login</button>
                                    <button onclick="doRegister()" class="btn btn-ghost">Register</button>
                                    <button onclick="closeAuth()" class="btn btn-ghost">Close</button>
                                </div>
                                <div id="authMsg" style="margin-top:8px;color:var(--text-muted)"></div>
                            </div>
                        </div>`;
                        const tmp = document.createElement('div'); tmp.innerHTML = html; document.body.appendChild(tmp.firstElementChild);
                }

                function closeAuth() { const m = document.getElementById('authModal'); if (m) m.remove(); }

                async function doRegister() {
                        const u = document.getElementById('authUser').value;
                        const p = document.getElementById('authPass').value;
                        const r = await fetch('/api/register', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p}) });
                        const j = await r.json();
                        document.getElementById('authMsg').textContent = j.error || (j.created ? 'Created ' + j.created : JSON.stringify(j));
                }

                async function doLogin() {
                        const u = document.getElementById('authUser').value;
                        const p = document.getElementById('authPass').value;
                        const r = await fetch('/api/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p}) });
                        const j = await r.json();
                        if (r.ok) {
                                document.getElementById('authMsg').textContent = 'Logged in ' + j.logged_in;
                                setTimeout(closeAuth, 800);
                        } else {
                                document.getElementById('authMsg').textContent = j.error || 'Login failed';
                        }
                }

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // MERGE / HISTORY PANEL
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                let mergeModal = null;
                let mergeEditors = { local: null, remote: null, merged: null };

                function openMergePanel(name, remoteContent, localContent) {
                        // create modal with a hunk chooser and three editors
                        if (mergeModal) mergeModal.remove();
                        const html = `
                        <div class="modal" id="mergeModal">
                            <div class="modal-window merge-window">
                                <div class="merge-header">
                                    <h3>Merge: ${name}</h3>
                                    <div class="merge-actions">
                                        <button class="btn" onclick="saveMergedToServer('${name}')">Save Merged</button>
                                        <button class="btn" onclick="doAutoThreeWayMerge('${name}')">Auto 3-way Merge</button>
                                        <button class="btn btn-ghost" onclick="closeMerge()">Cancel</button>
                                    </div>
                                </div>
                                <div class="merge-body">
                                    <div class="merge-side">
                                        <div class="merge-title">Base</div>
                                        <div id="mergeBase" class="merge-editor"></div>
                                    </div>
                                    <div class="merge-side">
                                        <div class="merge-title">Local</div>
                                        <div id="mergeLocal" class="merge-editor"></div>
                                    </div>
                                    <div class="merge-side">
                                        <div class="merge-title">Remote</div>
                                        <div id="mergeRemote" class="merge-editor"></div>
                                    </div>
                                </div>
                                <div class="merge-center">
                                    <div class="merge-title">Hunks</div>
                                    <div id="hunksList" class="hunks-list"></div>
                                    <div style="margin-top:8px">Choose Base / Local / Remote for each hunk to build the merged result.</div>
                                </div>
                                <div class="merge-footer">
                                    <div class="merge-title">Merged</div>
                                    <div id="mergeMerged" class="merge-merged"></div>
                                </div>
                            </div>
                        </div>`;
                        const tmp = document.createElement('div'); tmp.innerHTML = html; document.body.appendChild(tmp.firstElementChild);
                        mergeModal = document.getElementById('mergeModal');

                        // create editors once require is ready
                        require(['vs/editor/editor.main'], function () {
                                mergeEditors.base = monaco.editor.create(document.getElementById('mergeBase'), { value: 'Loading base...', language: 'tinytalk', automaticLayout: true, minimap:{enabled:false}, readOnly: true });
                                mergeEditors.local = monaco.editor.create(document.getElementById('mergeLocal'), { value: localContent, language: 'tinytalk', automaticLayout: true, minimap:{enabled:false}, readOnly: true });
                                mergeEditors.remote = monaco.editor.create(document.getElementById('mergeRemote'), { value: remoteContent, language: 'tinytalk', automaticLayout: true, minimap:{enabled:false}, readOnly: true });
                                mergeEditors.merged = monaco.editor.create(document.getElementById('mergeMerged'), { value: localContent, language: 'tinytalk', automaticLayout: true, minimap:{enabled:false} });

                                // fetch base/ancestor version and build 3-way hunks
                                (async function(){
                                    try {
                                        // fetch versions
                                        const mv = await fetch(`/api/scripts/${encodeURIComponent(name)}`);
                                        if (!mv.ok) {
                                            buildHunksUI(localContent, remoteContent);
                                            return;
                                        }
                                        const mvj = await mv.json();
                                        const versions = mvj.versions || [];
                                        if (versions.length < 2) {
                                            // no history: use local as base
                                            mergeEditors.base.setValue(localContent);
                                            buildHunksUI(localContent, remoteContent);
                                            return;
                                        }
                                        const v2 = versions[versions.length-1].id;
                                        const v1 = versions[versions.length-2].id;
                                        // ask server for base
                                        const bres = await fetch(`/api/scripts/${encodeURIComponent(name)}/ancestor?v1=${v1}&v2=${v2}`);
                                        let baseId = null;
                                        if (bres.ok) {
                                            const bj = await bres.json(); baseId = bj.base_id;
                                        }
                                        let baseContent = localContent;
                                        if (baseId) {
                                            const baseR = await fetch(`/api/scripts/${encodeURIComponent(name)}/version/${baseId}`);
                                            if (baseR.ok) {
                                                const baseJ = await baseR.json(); baseContent = baseJ.content || localContent;
                                            }
                                        }
                                        mergeEditors.base.setValue(baseContent);
                                        buildHunks3UI(baseContent, localContent, remoteContent);
                                    } catch (e) {
                                        mergeEditors.base.setValue(localContent);
                                        buildHunksUI(localContent, remoteContent);
                                    }
                                })();
                        });
                }

                function buildHunksUI(localText, remoteText) {
                    // Fallback simple two-way hunks UI (kept for compatibility)
                    const hunks = Diff.diffLines(localText, remoteText);
                    const list = document.getElementById('hunksList');
                    list.innerHTML = '';
                    let idx = 0;
                    for (let i = 0; i < hunks.length; i++) {
                        const h = hunks[i];
                        if (h.added || h.removed) {
                            const id = 'hunk-' + (idx++);
                            const el = document.createElement('div');
                            el.className = 'hunk-item';
                            el.innerHTML = `<div class="hunk-header"><span class="hunk-id">${id}</span>
                                <div class="hunk-actions">
                                    <button class="btn btn-sm" data-hunkid="${i}" data-action="local">Apply Local</button>
                                    <button class="btn btn-sm" data-hunkid="${i}" data-action="remote">Apply Remote</button>
                                </div>
                                </div>
                                <pre class="hunk-preview">${escapeHtml(h.value)}</pre>`;
                            el.querySelector('[data-action="local"]').addEventListener('click', () => applyHunk(i, 'local'));
                            el.querySelector('[data-action="remote"]').addEventListener('click', () => applyHunk(i, 'remote'));
                            list.appendChild(el);
                        }
                    }
                    if (list.children.length === 0) list.innerHTML = '<div class="hunk-empty">No differences detected</div>';
                }

                // Decorations state for merge highlighting
                let mergeDecorations = { base: [], local: [], remote: [] };

                function clearMergeDecorations() {
                    if (mergeEditors.base) mergeDecorations.base = mergeEditors.base.deltaDecorations(mergeDecorations.base, []);
                    if (mergeEditors.local) mergeDecorations.local = mergeEditors.local.deltaDecorations(mergeDecorations.local, []);
                    if (mergeEditors.remote) mergeDecorations.remote = mergeEditors.remote.deltaDecorations(mergeDecorations.remote, []);
                }

                function highlightRangeInEditors(start, end) {
                    clearMergeDecorations();
                    const range = new monaco.Range(start+1, 1, Math.max(end, start+1), 1);
                    const opts = [{ range, options: { isWholeLine: true, className: 'merge-line-highlight', glyphMarginClassName: 'merge-gutter' } }];
                    if (mergeEditors.base) mergeDecorations.base = mergeEditors.base.deltaDecorations(mergeDecorations.base, opts);
                    if (mergeEditors.local) mergeDecorations.local = mergeEditors.local.deltaDecorations(mergeDecorations.local, opts);
                    if (mergeEditors.remote) mergeDecorations.remote = mergeEditors.remote.deltaDecorations(mergeDecorations.remote, opts);
                }

                // Build 3-way hunks using base/local/remote
                function buildHunks3UI(baseText, localText, remoteText) {
                    const baseLines = baseText.split('\n');
                    const localLines = localText.split('\n');
                    const remoteLines = remoteText.split('\n');

                    // Map base indexes to local indexes and collect insertions
                    function mapBaseToTarget(baseText, targetText) {
                        const chunks = Diff.diffLines(baseText, targetText);
                        const baseToTarget = new Array(baseLines.length).fill(null);
                        const insertsAt = Array.from({length: baseLines.length+1}, () => []);
                        let bIdx = 0, tIdx = 0;
                        for (const ch of chunks) {
                            if (ch.added) {
                                const addedLines = ch.value.split('\n');
                                if (addedLines.length && addedLines[addedLines.length-1] === '') addedLines.pop();
                                insertsAt[bIdx] = insertsAt[bIdx].concat(addedLines);
                                tIdx += addedLines.length;
                            } else if (ch.removed) {
                                const rem = ch.value.split('\n');
                                if (rem.length && rem[rem.length-1] === '') rem.pop();
                                for (let i=0;i<rem.length;i++) { baseToTarget[bIdx++] = null; }
                            } else {
                                const eq = ch.value.split('\n');
                                if (eq.length && eq[eq.length-1] === '') eq.pop();
                                for (let i=0;i<eq.length;i++) { baseToTarget[bIdx] = tIdx; bIdx++; tIdx++; }
                            }
                        }
                        return { baseToTarget, insertsAt };
                    }

                    const localMap = mapBaseToTarget(baseText, localText);
                    const remoteMap = mapBaseToTarget(baseText, remoteText);

                    // mark changed base indices where local or remote differ
                    const changed = new Array(baseLines.length+1).fill(false);
                    for (let i=0;i<baseLines.length;i++) {
                        const baseLine = baseLines[i];
                        const lidx = localMap.baseToTarget[i];
                        const ridx = remoteMap.baseToTarget[i];
                        const localLine = lidx === null || lidx === undefined ? null : localLines[lidx];
                        const remoteLine = ridx === null || ridx === undefined ? null : remoteLines[ridx];
                        if (localLine !== baseLine) changed[i] = true;
                        if (remoteLine !== baseLine) changed[i] = true;
                    }
                    // also mark insertions as changes
                    for (let i=0;i<localMap.insertsAt.length;i++) if (localMap.insertsAt[i].length) changed[i] = true;
                    for (let i=0;i<remoteMap.insertsAt.length;i++) if (remoteMap.insertsAt[i].length) changed[i] = true;

                    // group contiguous changed ranges
                    const hunks = [];
                    let i = 0;
                    while (i <= baseLines.length) {
                        if (!changed[i]) { i++; continue; }
                        const start = i;
                        while (i <= baseLines.length && changed[i]) i++;
                        const end = i; // exclusive in terms of base index

                        // build base segment
                        const baseSeg = baseLines.slice(start, end).join('\n');

                        // build local segment using inserts and mapped lines
                        const localSegParts = [];
                        for (let bi = start; bi < end; bi++) {
                            if (localMap.insertsAt[bi] && localMap.insertsAt[bi].length) localSegParts.push(...localMap.insertsAt[bi]);
                            const li = localMap.baseToTarget[bi];
                            if (li !== null && li !== undefined) localSegParts.push(localLines[li]);
                        }
                        if (localMap.insertsAt[end] && localMap.insertsAt[end].length) localSegParts.push(...localMap.insertsAt[end]);
                        const localSeg = localSegParts.join('\n');

                        // build remote segment similarly
                        const remoteSegParts = [];
                        for (let bi = start; bi < end; bi++) {
                            if (remoteMap.insertsAt[bi] && remoteMap.insertsAt[bi].length) remoteSegParts.push(...remoteMap.insertsAt[bi]);
                            const ri = remoteMap.baseToTarget[bi];
                            if (ri !== null && ri !== undefined) remoteSegParts.push(remoteLines[ri]);
                        }
                        if (remoteMap.insertsAt[end] && remoteMap.insertsAt[end].length) remoteSegParts.push(...remoteMap.insertsAt[end]);
                        const remoteSeg = remoteSegParts.join('\n');

                        hunks.push({ start, end, baseSeg, localSeg, remoteSeg });
                    }

                    const list = document.getElementById('hunksList');
                    list.innerHTML = '';
                    if (hunks.length === 0) { list.innerHTML = '<div class="hunk-empty">No differences detected</div>'; return; }
                        hunks.forEach((h, idx) => {
                        const isConflict = (h.localSeg !== h.baseSeg && h.remoteSeg !== h.baseSeg && h.localSeg !== h.remoteSeg);
                        const el = document.createElement('div');
                        el.className = 'hunk-item' + (isConflict ? ' hunk-conflict' : '');
                        el.innerHTML = `<div class="hunk-header"><span class="hunk-id">hunk-${idx}</span>
                            <div class="hunk-actions">
                                <button class="btn btn-sm" data-idx="${idx}" data-choice="base">Use Base</button>
                                <button class="btn btn-sm" data-idx="${idx}" data-choice="local">Use Local</button>
                                <button class="btn btn-sm" data-idx="${idx}" data-choice="remote">Use Remote</button>
                            </div>
                            </div>
                            <div class="hunk-grid">
                            <div class="hunk-col"><div class="hunk-subtitle">Base</div><pre class="hunk-preview">${escapeHtml(h.baseSeg)}</pre></div>
                            <div class="hunk-col"><div class="hunk-subtitle">Local</div><pre class="hunk-preview">${escapeHtml(h.localSeg)}</pre></div>
                            <div class="hunk-col"><div class="hunk-subtitle">Remote</div><pre class="hunk-preview">${escapeHtml(h.remoteSeg)}</pre></div>
                            </div>`;
                        el.querySelectorAll('button[data-choice]').forEach(btn => {
                            btn.addEventListener('click', () => { applyHunk3(idx, btn.dataset.choice); highlightRangeInEditors(h.start, h.end); });
                            btn.addEventListener('mouseenter', () => highlightRangeInEditors(h.start, h.end));
                            btn.addEventListener('mouseleave', () => clearMergeDecorations());
                        });
                        list.appendChild(el);
                    });
                    // expose hunks for inline widget matching
                    window.latestHunks = hunks;
                }

                function applyHunk3(hunkIndex, choice) {
                    const merged = mergeEditors.merged.getValue().split('\n');
                    const base = mergeEditors.base.getValue().split('\n');
                    const local = mergeEditors.local.getValue().split('\n');
                    const remote = mergeEditors.remote.getValue().split('\n');
                    // rebuild hunks to get ranges
                    const maxn = Math.max(base.length, local.length, remote.length);
                    const ranges = [];
                    let i = 0;
                    while (i < maxn) {
                        const be = base[i] || '';
                        const le = local[i] || '';
                        const re = remote[i] || '';
                        if (le === be && re === be) { i++; continue; }
                        const start = i;
                        while (i < maxn) {
                            const be2 = base[i] || '';
                            const le2 = local[i] || '';
                            const re2 = remote[i] || '';
                            if (le2 === be2 && re2 === be2) break;
                            i++;
                        }
                        const end = i;
                        ranges.push({ start, end });
                    }
                    if (hunkIndex < 0 || hunkIndex >= ranges.length) return;
                    const r = ranges[hunkIndex];
                    const chosenLines = (choice === 'base' ? base.slice(r.start, r.end) : (choice === 'local' ? local.slice(r.start, r.end) : remote.slice(r.start, r.end)));
                    // Replace in merged (ensure merged has at least as many lines)
                    while (merged.length < r.start) merged.push('');
                    merged.splice(r.start, r.end - r.start, ...chosenLines);
                    mergeEditors.merged.setValue(merged.join('\n'));
                    showStatus('Applied ' + choice + ' for hunk ' + hunkIndex);
                    renderConflictWidgets();
                }

                function applyHunk(hunkIndex, choice) {
                        // Recompute hunks and rebuild merged value by choosing chunks
                        const local = mergeEditors.local.getValue();
                        const remote = mergeEditors.remote.getValue();
                        const hunks = Diff.diffLines(local, remote);
                        let merged = '';
                        for (let i = 0; i < hunks.length; i++) {
                                const h = hunks[i];
                                if (h.added || h.removed) {
                                        if (i === hunkIndex) {
                                                merged += (choice === 'local' ? (h.removed ? h.value : '') : (h.added ? h.value : ''));
                                        } else {
                                                // prefer local for removed chunks, remote for added
                                                if (h.removed) merged += h.value; else if (h.added) merged += h.value; else merged += h.value;
                                        }
                                } else {
                                        merged += h.value;
                                }
                        }
                        if (mergeEditors.merged) mergeEditors.merged.setValue(merged);
                        showStatus('Applied ' + choice + ' hunk');
                }

                function escapeHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

                function closeMerge() { if (mergeModal) { mergeModal.remove(); mergeModal = null; mergeEditors = { local: null, remote: null, merged: null }; } }

                function copyLocalToMerged() { if (mergeEditors.local && mergeEditors.merged) mergeEditors.merged.setValue(mergeEditors.local.getValue()); }
                function copyRemoteToMerged() { if (mergeEditors.remote && mergeEditors.merged) mergeEditors.merged.setValue(mergeEditors.remote.getValue()); }

                async function saveMergedToServer(name) {
                        if (!mergeEditors.merged) return;
                        const merged = mergeEditors.merged.getValue();
                        const r = await fetch(`/api/scripts/${encodeURIComponent(name)}/merge`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ merged, message: 'merged via UI' }) });
                        const j = await r.json();
                        if (r.ok) {
                                showStatus('Merged saved');
                                // update local script and close
                                scripts[name] = merged;
                                saveAllToStorage();
                                closeMerge();
                        } else {
                                showStatus('Merge failed: ' + (j.error || ''));
                        }
                }

                // Inline conflict widgets in merged editor
                let conflictWidgets = [];
                function clearConflictWidgets() {
                    conflictWidgets.forEach(w => w.el.remove());
                    conflictWidgets = [];
                }

                function renderConflictWidgets() {
                    if (!mergeEditors.merged) return;
                    clearConflictWidgets();
                    const content = mergeEditors.merged.getValue();
                    const lines = content.split('\n');
                    let i = 0;
                    while (i < lines.length) {
                        if (lines[i] === '<<<<<<< A') {
                            const start = i;
                            i++;
                            const aLines = [];
                            while (i < lines.length && lines[i] !== '=======') { aLines.push(lines[i]); i++; }
                            if (i >= lines.length) break;
                            i++; // skip =======
                            const bLines = [];
                            while (i < lines.length && lines[i] !== '>>>>>>> B') { bLines.push(lines[i]); i++; }
                            if (i >= lines.length) break;
                            const end = i; // index of >>>>>> B

                            // create widget
                            const top = mergeEditors.merged.getTopForLineNumber(start+1);
                            const container = mergeEditors.merged.getDomNode().parentElement; // editor container
                            const widget = document.createElement('div');
                            widget.className = 'conflict-widget';
                            widget.style.left = (container.getBoundingClientRect().left + 12) + 'px';
                            widget.style.top = (container.getBoundingClientRect().top + top) + 'px';
                            const btnBase = document.createElement('button'); btnBase.textContent = 'Accept Base';
                            const btnLocal = document.createElement('button'); btnLocal.textContent = 'Accept Local';
                            const btnRemote = document.createElement('button'); btnRemote.textContent = 'Accept Remote';
                            widget.appendChild(btnBase); widget.appendChild(btnLocal); widget.appendChild(btnRemote);
                            document.body.appendChild(widget);
                            const idxStart = start; const idxEnd = end;
                            btnLocal.addEventListener('click', () => {
                                // replace with local lines
                                const editRange = { startLineNumber: idxStart+1, endLineNumber: idxEnd+1 };
                                const newText = aLines.join('\n');
                                mergeEditors.merged.executeEdits('conflict', [{ range: new monaco.Range(editRange.startLineNumber,1, editRange.endLineNumber,1), text: newText }]);
                                renderConflictWidgets();
                            });
                            btnBase.addEventListener('click', () => {
                                // try to find matching hunk to use base slice
                                let baseText = '';
                                if (window.latestHunks) {
                                    const needleA = aLines.join('\n');
                                    const needleB = bLines.join('\n');
                                    for (const h of window.latestHunks) {
                                        if (h.localSeg === needleA && h.remoteSeg === needleB) {
                                            const baseAll = mergeEditors.base ? mergeEditors.base.getValue().split('\n') : [];
                                            baseText = (baseAll.slice(h.start, h.end) || []).join('\n');
                                            break;
                                        }
                                    }
                                }
                                const editRange = { startLineNumber: idxStart+1, endLineNumber: idxEnd+1 };
                                mergeEditors.merged.executeEdits('conflict', [{ range: new monaco.Range(editRange.startLineNumber,1, editRange.endLineNumber,1), text: baseText }]);
                                renderConflictWidgets();
                            });
                            btnRemote.addEventListener('click', () => {
                                const editRange = { startLineNumber: idxStart+1, endLineNumber: idxEnd+1 };
                                const newText = bLines.join('\n');
                                mergeEditors.merged.executeEdits('conflict', [{ range: new monaco.Range(editRange.startLineNumber,1, editRange.endLineNumber,1), text: newText }]);
                                renderConflictWidgets();
                            });
                            conflictWidgets.push({ el: widget, start, end });
                        }
                        i++;
                    }
                }

                async function doAutoThreeWayMerge(name) {
                    try {
                        const r = await fetch(`/api/scripts/${encodeURIComponent(name)}`);
                        if (!r.ok) {
                            showStatus('Could not fetch remote versions');
                            return;
                        }
                        const j = await r.json();
                        const versions = j.versions || [];
                        if (versions.length < 2) {
                            showStatus('Need at least two remote versions to perform 3-way merge');
                            return;
                        }
                        const v2 = versions[versions.length - 1].id;
                        const v1 = versions[versions.length - 2].id;

                        const r2 = await fetch(`/api/scripts/${encodeURIComponent(name)}/merge3`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ v1, v2 })
                        });
                        const j2 = await r2.json();
                        if (!r2.ok) {
                            showStatus('Merge failed: ' + (j2.error || ''));
                            return;
                        }
                        if (mergeEditors.merged) mergeEditors.merged.setValue(j2.merged.content || '');
                        if (j2.merged.conflicts) alert('Merge produced conflicts â€” conflict markers included in merged buffer.');
                        showStatus('Auto 3-way merge complete');
                    } catch (err) {
                        showStatus('Auto merge failed: ' + err.message);
                    }
                }


        
        // Tab switching
        function switchOutputTab(tab) {
            currentOutputTab = tab;
            
            // Update tab active states
            document.querySelectorAll('.output-tab').forEach(el => {
                el.classList.toggle('active', el.dataset.tab === tab);
            });
            
            // Show/hide content
            document.getElementById('outputContent').style.display = tab === 'output' ? 'block' : 'none';
            document.getElementById('jsContent').style.display = tab === 'javascript' ? 'flex' : 'none';
            document.getElementById('pyContent').style.display = tab === 'python' ? 'flex' : 'none';
            
            // Create and layout Monaco editors when tab is shown
            if (tab === 'javascript') {
                const ed = ensureJsEditor();
                setTimeout(() => ed.layout(), 100);
            }
            if (tab === 'python') {
                const ed = ensurePyEditor();
                setTimeout(() => ed.layout(), 100);
            }
        }
        
        // Make switchOutputTab globally accessible
        window.switchOutputTab = switchOutputTab;
        
        // Copy code function
        function copyCode(lang) {
            let code = '';
            if (lang === 'js') {
                const ed = ensureJsEditor();
                code = ed.getValue();
            } else if (lang === 'py') {
                const ed = ensurePyEditor();
                code = ed.getValue();
            }
            
            navigator.clipboard.writeText(code).then(() => {
                // Brief visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ Copied!';
                setTimeout(() => btn.textContent = originalText, 1500);
            });
        }

        // Expose auth/merge helpers globally
        window.openAuth = openAuth;
        window.openMergePanel = openMergePanel;
        window.showHistory = showHistory;
        
        window.copyCode = copyCode;
        
        // Transpile code
        async function transpileCode(code) {
            // Transpile to JavaScript
            try {
                const jsResponse = await fetch('/api/transpile/js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, include_runtime: true })
                });
                const jsResult = await jsResponse.json();
                const jsEd = ensureJsEditor();
                if (jsResult.success) {
                    jsEd.setValue(jsResult.code);
                } else {
                    jsEd.setValue('// Error transpiling to JavaScript:\n// ' + (jsResult.error || 'Unknown error'));
                }
            } catch (err) {
                const jsEd = ensureJsEditor();
                jsEd.setValue('// Error: ' + err.message);
            }
            
            // Transpile to Python
            try {
                const pyResponse = await fetch('/api/transpile/python', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, include_runtime: true })
                });
                const pyResult = await pyResponse.json();
                const pyEd = ensurePyEditor();
                if (pyResult.success) {
                    pyEd.setValue(pyResult.code);
                } else {
                    pyEd.setValue('# Error transpiling to Python:\n# ' + (pyResult.error || 'Unknown error'));
                }
            } catch (err) {
                const pyEd = ensurePyEditor();
                pyEd.setValue('# Error: ' + err.message);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RUN CODE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function runCode() {
            const code = editor.getValue();
            const runBtn = document.getElementById('runBtn');
            const statusBadge = document.getElementById('statusBadge');
            const outputContent = document.getElementById('outputContent');

            runBtn.disabled = true;
            runBtn.innerHTML = '<div class="spinner"></div> Running...';
            statusBadge.className = 'status-badge status-running';
            statusBadge.textContent = 'Running...';
            
            // Transpile in parallel
            transpileCode(code);

            try {
                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                const result = await response.json();

                if (result.success) {
                    statusBadge.className = 'status-badge status-success';
                    statusBadge.textContent = 'Success';
                } else {
                    statusBadge.className = 'status-badge status-error';
                    statusBadge.textContent = 'Error';
                }

                let html = '';

                if (result.output) {
                    html += `
                        <div class="output-section">
                            <div class="output-label">Output</div>
                            <div class="output-text">${escapeHtml(result.output)}</div>
                        </div>
                    `;
                }

                if (result.result && result.result !== 'null') {
                    html += `
                        <div class="output-section">
                            <div class="output-label">Result</div>
                            <div class="output-text success">${escapeHtml(result.result)}</div>
                        </div>
                    `;
                }

                if (result.error) {
                    html += `
                        <div class="output-section">
                            <div class="output-label">Error</div>
                            <div class="output-text error">${escapeHtml(result.error)}</div>
                        </div>
                    `;
                }

                if (!result.output && !result.result && !result.error) {
                    html += `<div class="output-text" style="color: var(--text-muted);">No output</div>`;
                }

                html += `
                    <div class="output-meta">
                        <div class="meta-item">â±ï¸ <span class="meta-value">${result.elapsed_ms}ms</span></div>
                        <div class="meta-item">âœ“ <span class="meta-value">Verified</span></div>
                    </div>
                `;

                outputContent.innerHTML = html;

            } catch (err) {
                statusBadge.className = 'status-badge status-error';
                statusBadge.textContent = 'Error';
                outputContent.innerHTML = `
                    <div class="output-section">
                        <div class="output-label">Error</div>
                        <div class="output-text error">Connection failed: ${escapeHtml(err.message)}</div>
                    </div>
                `;
            }

            runBtn.disabled = false;
            runBtn.innerHTML = 'â–¶ Run <kbd>Ctrl+â†µ</kbd>';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Set initial theme option as active
        document.querySelectorAll('.theme-option').forEach(el => {
            el.classList.toggle('active', el.dataset.theme === currentTheme);
        });
    </script>
</body>
</html>