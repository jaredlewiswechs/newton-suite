<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Adan</title>
    <style>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           APPLE HIG 2025 - LIGHT MODE
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        :root {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F5F5F7;
            --bg-tertiary: #E8E8ED;
            --bg-grouped: #F2F2F7;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --text-tertiary: #AEAEB2;
            --accent: #007AFF;
            --accent-hover: #0066CC;
            --accent-light: rgba(0, 122, 255, 0.1);
            --success: #34C759;
            --success-light: rgba(52, 199, 89, 0.12);
            --warning: #FF9500;
            --error: #FF3B30;
            --error-light: rgba(255, 59, 48, 0.12);
            --calc-operator: #FF9500;
            --border: rgba(0, 0, 0, 0.08);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 0.5px solid var(--border);
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left { display: flex; align-items: center; gap: 12px; }

        .logo {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 22px; color: white;
        }

        .header-text h1 { font-size: 17px; font-weight: 600; letter-spacing: -0.02em; }
        .header-text p { font-size: 12px; color: var(--text-secondary); margin-top: 1px; }

        .header-right { display: flex; align-items: center; gap: 12px; }

        .status-pill {
            display: flex; align-items: center; gap: 6px;
            font-size: 13px; font-weight: 500; color: var(--success);
            background: var(--success-light); padding: 6px 12px; border-radius: var(--radius-full);
        }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }

        .invariant-badge {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 11px; font-weight: 500; color: var(--accent);
            background: var(--accent-light); padding: 5px 10px; border-radius: var(--radius-sm);
        }

        /* Layout */
        .app-container {
            display: flex; max-width: 1400px; margin: 0 auto; min-height: calc(100vh - 65px);
        }

        .main-panel { flex: 1; display: flex; flex-direction: column; padding: 24px; max-width: 800px; }
        .side-panel { width: 360px; padding: 24px; padding-left: 0; display: flex; flex-direction: column; gap: 16px; }

        @media (max-width: 1024px) { .side-panel { display: none; } .main-panel { max-width: 100%; } }

        /* Messages */
        .messages { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; padding-bottom: 24px; }

        .message { display: flex; gap: 14px; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

        .message-avatar {
            width: 36px; height: 36px; border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 15px; flex-shrink: 0;
        }

        .message.user .message-avatar { background: var(--bg-tertiary); color: var(--text-secondary); }
        .message.assistant .message-avatar { background: linear-gradient(135deg, #007AFF, #5856D6); color: white; }

        .message-content { flex: 1; min-width: 0; }
        .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .message-name { font-weight: 600; font-size: 15px; }
        .message-time { font-size: 12px; color: var(--text-tertiary); }

        .message-body {
            background: var(--bg-primary); border-radius: var(--radius-lg);
            padding: 16px; box-shadow: var(--shadow-sm); border: 0.5px solid var(--border);
        }

        .message.user .message-body { background: var(--accent); color: white; border: none; }
        .message-text { font-size: 15px; line-height: 1.55; }
        .message-text p { margin-bottom: 12px; }
        .message-text p:last-child { margin-bottom: 0; }
        .message-text code { font-family: 'Consolas', 'Courier New', monospace; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; font-size: 14px; }
        .message.user .message-text code { background: rgba(255,255,255,0.2); }

        .message-verification {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 12px; font-weight: 500; padding: 4px 10px;
            border-radius: var(--radius-full); margin-top: 10px;
        }
        .message-verification.verified { background: var(--success-light); color: var(--success); }
        .message-verification.unverified { background: var(--error-light); color: var(--error); }

        /* Input */
        .input-area {
            background: var(--bg-primary); border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md); border: 0.5px solid var(--border);
            padding: 8px; display: flex; align-items: flex-end; gap: 8px;
        }

        .input-wrapper { flex: 1; }

        #message-input {
            width: 100%; font-family: inherit; font-size: 16px; line-height: 1.5;
            padding: 12px 16px; border: none; background: transparent;
            color: var(--text-primary); resize: none; outline: none;
            min-height: 48px; max-height: 200px;
        }
        #message-input::placeholder { color: var(--text-tertiary); }

        .send-btn {
            width: 44px; height: 44px; border-radius: var(--radius-md);
            border: none; background: var(--accent); color: white;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.15s ease; flex-shrink: 0;
        }
        .send-btn:hover { background: var(--accent-hover); transform: scale(1.02); }
        .send-btn:active { transform: scale(0.98); }
        .send-btn svg { width: 20px; height: 20px; }

        /* Calculator Card */
        .calculator-card {
            background: var(--bg-primary); border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md); border: 0.5px solid var(--border); overflow: hidden;
        }

        .calc-header {
            padding: 16px 20px; border-bottom: 0.5px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .calc-title { display: flex; align-items: center; gap: 10px; }
        .calc-title h3 { font-size: 15px; font-weight: 600; }
        .calc-icon {
            width: 28px; height: 28px; background: linear-gradient(135deg, #FF9500, #FF6B00);
            border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;
            color: white; font-size: 14px;
        }
        .calc-badge { font-size: 11px; font-weight: 500; color: var(--success); background: var(--success-light); padding: 4px 8px; border-radius: var(--radius-full); }

        .calc-display { padding: 20px; background: var(--bg-grouped); }
        .calc-expression { font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; color: var(--text-secondary); min-height: 20px; margin-bottom: 4px; text-align: right; }
        .calc-result { font-family: 'Consolas', 'Courier New', monospace; font-size: 36px; font-weight: 500; text-align: right; color: var(--text-primary); }

        .calc-keypad { padding: 16px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }

        .calc-btn {
            aspect-ratio: 1; border-radius: var(--radius-md); border: none;
            font-family: 'Consolas', 'Courier New', monospace; font-size: 16px; font-weight: 500;
            cursor: pointer; transition: all 0.1s ease;
            display: flex; align-items: center; justify-content: center;
            min-height: 48px;
        }
        .calc-btn.number { background: var(--bg-primary); color: var(--text-primary); border: 0.5px solid var(--border); }
        .calc-btn.number:hover { background: var(--bg-tertiary); }
        .calc-btn.operator { background: var(--calc-operator); color: white; }
        .calc-btn.operator:hover { filter: brightness(1.1); }
        .calc-btn.function { background: var(--bg-tertiary); color: var(--text-primary); font-size: 13px; }
        .calc-btn.function:hover { background: #D1D1D6; }
        .calc-btn.equal { background: var(--accent); color: white; }
        .calc-btn.equal:hover { background: var(--accent-hover); }
        .calc-btn.wide { grid-column: span 2; aspect-ratio: auto; }
        .calc-btn:active { transform: scale(0.96); }

        .calc-footer { padding: 12px 16px; border-top: 0.5px solid var(--border); font-size: 11px; color: var(--text-tertiary); text-align: center; }

        /* Stats Card */
        .stats-card { background: var(--bg-primary); border-radius: var(--radius-xl); box-shadow: var(--shadow-md); border: 0.5px solid var(--border); padding: 20px; }
        .stats-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
        .stats-icon { width: 28px; height: 28px; background: linear-gradient(135deg, #34C759, #30D158); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }
        .stats-title { font-size: 15px; font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .stat-item { background: var(--bg-grouped); border-radius: var(--radius-md); padding: 14px; }
        .stat-value { font-family: 'Consolas', 'Courier New', monospace; font-size: 24px; font-weight: 600; color: var(--text-primary); }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

        /* Empty State */
        .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 32px; }
        .empty-icon { width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-light), rgba(88, 86, 214, 0.1)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .empty-icon svg { width: 40px; height: 40px; color: var(--accent); }
        .empty-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .empty-subtitle { font-size: 15px; color: var(--text-secondary); max-width: 320px; line-height: 1.5; }
        .suggestions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 24px; justify-content: center; }
        .suggestion-chip { padding: 10px 16px; background: var(--bg-primary); border: 0.5px solid var(--border); border-radius: var(--radius-full); font-size: 14px; cursor: pointer; transition: all 0.15s ease; }
        .suggestion-chip:hover { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }

        /* Mobile */
        .mobile-calc-toggle { display: none; position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: linear-gradient(135deg, #FF9500, #FF6B00); border-radius: var(--radius-lg); box-shadow: 0 8px 24px rgba(0,0,0,0.12); border: none; color: white; font-size: 24px; cursor: pointer; z-index: 90; }
        @media (max-width: 1024px) { .mobile-calc-toggle { display: flex; align-items: center; justify-content: center; } }
        .mobile-calc-panel { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-primary); border-radius: var(--radius-xl) var(--radius-xl) 0 0; box-shadow: 0 -4px 24px rgba(0,0,0,0.15); z-index: 95; max-height: 70vh; overflow-y: auto; }
        .mobile-calc-panel.open { display: block; animation: slideUpPanel 0.3s ease; }
        @keyframes slideUpPanel { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .mobile-calc-handle { width: 36px; height: 5px; background: var(--bg-tertiary); border-radius: var(--radius-full); margin: 8px auto; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">A</div>
            <div class="header-text">
                <h1>Adan</h1>
                <p>Ada + Newton: Self-Verifying AI</p>
            </div>
        </div>
        <div class="header-right">
            <div class="status-pill"><span class="status-dot"></span><span>Online</span></div>
            <span class="invariant-badge">1 == 1</span>
        </div>
    </header>

    <div class="app-container">
        <main class="main-panel">
            <div class="messages" id="messages">
                <div class="empty-state" id="empty-state">
                    <div class="empty-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                    </div>
                    <h2 class="empty-title">Ask Newton anything</h2>
                    <p class="empty-subtitle">Every response is verified. Every claim is grounded. No hallucinations.</p>
                    <div class="suggestions">
                        <button class="suggestion-chip" onclick="askQuestion('What is the capital of France?')">Capital of France</button>
                        <button class="suggestion-chip" onclick="askQuestion('Who founded Apple?')">Who founded Apple?</button>
                        <button class="suggestion-chip" onclick="askQuestion('What is 127 * 43?')">127 √ó 43</button>
                        <button class="suggestion-chip" onclick="askQuestion('What is the speed of light?')">Speed of light</button>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <textarea id="message-input" placeholder="Ask a question..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
                </div>
                <button class="send-btn" onclick="sendMessage()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5m0 0l-7 7m7-7l7 7"/>
                    </svg>
                </button>
            </div>
        </main>

        <aside class="side-panel">
            <div class="calculator-card">
                <div class="calc-header">
                    <div class="calc-title"><div class="calc-icon">‚àë</div><h3>Calculator</h3></div>
                    <span class="calc-badge">Logic Engine</span>
                </div>
                <div class="calc-display">
                    <div class="calc-expression" id="calc-expression"></div>
                    <div class="calc-result" id="calc-result">0</div>
                </div>
                <div class="calc-keypad">
                    <button class="calc-btn function" onclick="calcFunc('sin')">sin</button>
                    <button class="calc-btn function" onclick="calcFunc('cos')">cos</button>
                    <button class="calc-btn function" onclick="calcFunc('tan')">tan</button>
                    <button class="calc-btn function" onclick="calcFunc('log')">log</button>
                    <button class="calc-btn function" onclick="calcFunc('sqrt')">‚àö</button>
                    <button class="calc-btn function" onclick="calcFunc('pow')">x¬≤</button>
                    <button class="calc-btn function" onclick="calcInput('(')">(</button>
                    <button class="calc-btn function" onclick="calcInput(')')">)</button>
                    <button class="calc-btn function" onclick="calcFunc('pi')">œÄ</button>
                    <button class="calc-btn function" onclick="calcClear()">C</button>
                    <button class="calc-btn number" onclick="calcInput('7')">7</button>
                    <button class="calc-btn number" onclick="calcInput('8')">8</button>
                    <button class="calc-btn number" onclick="calcInput('9')">9</button>
                    <button class="calc-btn operator" onclick="calcInput('√∑')">√∑</button>
                    <button class="calc-btn function" onclick="calcBackspace()">‚å´</button>
                    <button class="calc-btn number" onclick="calcInput('4')">4</button>
                    <button class="calc-btn number" onclick="calcInput('5')">5</button>
                    <button class="calc-btn number" onclick="calcInput('6')">6</button>
                    <button class="calc-btn operator" onclick="calcInput('√ó')">√ó</button>
                    <button class="calc-btn operator" onclick="calcInput('^')">^</button>
                    <button class="calc-btn number" onclick="calcInput('1')">1</button>
                    <button class="calc-btn number" onclick="calcInput('2')">2</button>
                    <button class="calc-btn number" onclick="calcInput('3')">3</button>
                    <button class="calc-btn operator" onclick="calcInput('-')">‚àí</button>
                    <button class="calc-btn operator" onclick="calcInput('%')">%</button>
                    <button class="calc-btn number wide" onclick="calcInput('0')">0</button>
                    <button class="calc-btn number" onclick="calcInput('.')">.</button>
                    <button class="calc-btn operator" onclick="calcInput('+')">+</button>
                    <button class="calc-btn equal" onclick="calcEvaluate()">=</button>
                </div>
                <div class="calc-footer">Powered by Newton Logic Engine ¬∑ Verified</div>
            </div>

            <div class="stats-card">
                <div class="stats-header"><div class="stats-icon">üìä</div><h3 class="stats-title">Session Stats</h3></div>
                <div class="stats-grid">
                    <div class="stat-item"><div class="stat-value" id="stat-queries">0</div><div class="stat-label">Queries</div></div>
                    <div class="stat-item"><div class="stat-value" id="stat-verified">100%</div><div class="stat-label">Verified</div></div>
                    <div class="stat-item"><div class="stat-value" id="stat-kb-hits">0</div><div class="stat-label">KB Hits</div></div>
                    <div class="stat-item"><div class="stat-value" id="stat-latency">0ms</div><div class="stat-label">Avg Latency</div></div>
                </div>
            </div>
        </aside>
    </div>

    <button class="mobile-calc-toggle" onclick="toggleMobileCalc()">‚àë</button>
    <div class="mobile-calc-panel" id="mobile-calc-panel">
        <div class="mobile-calc-handle"></div>
        <div class="calc-display">
            <div class="calc-expression" id="mobile-calc-expression"></div>
            <div class="calc-result" id="mobile-calc-result">0</div>
        </div>
        <div class="calc-keypad">
            <button class="calc-btn function" onclick="calcFunc('sin')">sin</button>
            <button class="calc-btn function" onclick="calcFunc('cos')">cos</button>
            <button class="calc-btn function" onclick="calcFunc('tan')">tan</button>
            <button class="calc-btn function" onclick="calcFunc('log')">log</button>
            <button class="calc-btn function" onclick="calcFunc('sqrt')">‚àö</button>
            <button class="calc-btn function" onclick="calcFunc('pow')">x¬≤</button>
            <button class="calc-btn function" onclick="calcInput('(')">(</button>
            <button class="calc-btn function" onclick="calcInput(')')">)</button>
            <button class="calc-btn function" onclick="calcFunc('pi')">œÄ</button>
            <button class="calc-btn function" onclick="calcClear()">C</button>
            <button class="calc-btn number" onclick="calcInput('7')">7</button>
            <button class="calc-btn number" onclick="calcInput('8')">8</button>
            <button class="calc-btn number" onclick="calcInput('9')">9</button>
            <button class="calc-btn operator" onclick="calcInput('√∑')">√∑</button>
            <button class="calc-btn function" onclick="calcBackspace()">‚å´</button>
            <button class="calc-btn number" onclick="calcInput('4')">4</button>
            <button class="calc-btn number" onclick="calcInput('5')">5</button>
            <button class="calc-btn number" onclick="calcInput('6')">6</button>
            <button class="calc-btn operator" onclick="calcInput('√ó')">√ó</button>
            <button class="calc-btn operator" onclick="calcInput('^')">^</button>
            <button class="calc-btn number" onclick="calcInput('1')">1</button>
            <button class="calc-btn number" onclick="calcInput('2')">2</button>
            <button class="calc-btn number" onclick="calcInput('3')">3</button>
            <button class="calc-btn operator" onclick="calcInput('-')">‚àí</button>
            <button class="calc-btn operator" onclick="calcInput('%')">%</button>
            <button class="calc-btn number wide" onclick="calcInput('0')">0</button>
            <button class="calc-btn number" onclick="calcInput('.')">.</button>
            <button class="calc-btn operator" onclick="calcInput('+')">+</button>
            <button class="calc-btn equal" onclick="calcEvaluate()">=</button>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let calcExpression = '';
        let stats = { queries: 0, verified: 0, kbHits: 0, totalLatency: 0 };

        function handleKeyDown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }

        function askQuestion(q) { document.getElementById('message-input').value = q; sendMessage(); }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message) return;

            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.style.display = 'none';

            addMessage('user', message);
            input.value = '';

            const startTime = performance.now();
            try {
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                const latency = Math.round(performance.now() - startTime);

                stats.queries++;
                stats.totalLatency += latency;
                if (data.verified) stats.verified++;
                if (data.kb_hit) stats.kbHits++;
                updateStats();

                addMessage('assistant', data.response || data.content, data.verified);
            } catch (error) {
                addMessage('assistant', 'Connection error. Please check if the server is running.', false);
            }
        }

        function addMessage(role, content, verified = true) {
            const messages = document.getElementById('messages');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageHtml = `
                <div class="message ${role}">
                    <div class="message-avatar">${role === 'user' ? 'U' : 'N'}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-name">${role === 'user' ? 'You' : 'Newton'}</span>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-body">
                            <div class="message-text">${formatMessage(content)}</div>
                            ${role === 'assistant' ? `<div class="message-verification ${verified ? 'verified' : 'unverified'}">${verified ? '‚úì Verified' : '‚ö† Unverified'}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            messages.insertAdjacentHTML('beforeend', messageHtml);
            messages.scrollTop = messages.scrollHeight;
        }

        function formatMessage(text) {
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/`(.*?)`/g, '<code>$1</code>').replace(/\n/g, '<br>');
        }

        function calcInput(c) { calcExpression += c; updateCalcDisplay(); }
        function calcFunc(fn) {
            const funcs = { sin: 'sin(', cos: 'cos(', tan: 'tan(', log: 'log(', sqrt: '‚àö(', pow: '^2', pi: 'œÄ' };
            calcExpression += funcs[fn] || ''; updateCalcDisplay();
        }
        function calcClear() { calcExpression = ''; updateCalcDisplay(); document.getElementById('calc-result').textContent = '0'; document.getElementById('mobile-calc-result').textContent = '0'; }
        function calcBackspace() { calcExpression = calcExpression.slice(0, -1); updateCalcDisplay(); }
        function updateCalcDisplay() { document.getElementById('calc-expression').textContent = calcExpression; document.getElementById('mobile-calc-expression').textContent = calcExpression; }

        async function calcEvaluate() {
            if (!calcExpression) return;
            let expr = calcExpression.replace(/√ó/g, '*').replace(/√∑/g, '/').replace(/‚àí/g, '-').replace(/œÄ/g, '3.14159265359').replace(/‚àö\(/g, 'sqrt(');
            try {
                const response = await fetch(`${API_BASE}/calculate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ expression: expr }) });
                const data = await response.json();
                const result = data.result !== undefined ? formatNumber(data.result) : 'Error';
                document.getElementById('calc-result').textContent = result;
                document.getElementById('mobile-calc-result').textContent = result;
            } catch {
                try {
                    const result = formatNumber(eval(expr));
                    document.getElementById('calc-result').textContent = result;
                    document.getElementById('mobile-calc-result').textContent = result;
                } catch { document.getElementById('calc-result').textContent = 'Error'; document.getElementById('mobile-calc-result').textContent = 'Error'; }
            }
        }

        function formatNumber(n) { if (typeof n !== 'number') return n; if (Number.isInteger(n)) return n.toString(); return n.toPrecision(10).replace(/\.?0+$/, ''); }
        function toggleMobileCalc() { document.getElementById('mobile-calc-panel').classList.toggle('open'); }
        function updateStats() {
            document.getElementById('stat-queries').textContent = stats.queries;
            document.getElementById('stat-verified').textContent = stats.queries > 0 ? Math.round((stats.verified / stats.queries) * 100) + '%' : '100%';
            document.getElementById('stat-kb-hits').textContent = stats.kbHits;
            document.getElementById('stat-latency').textContent = stats.queries > 0 ? Math.round(stats.totalLatency / stats.queries) + 'ms' : '0ms';
        }

        document.addEventListener('click', (e) => {
            const panel = document.getElementById('mobile-calc-panel');
            const toggle = document.querySelector('.mobile-calc-toggle');
            if (panel.classList.contains('open') && !panel.contains(e.target) && !toggle.contains(e.target)) panel.classList.remove('open');
        });
    </script>
</body>
</html>
