<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nina ‚Äî Verified Computation Service</title>
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --bg-card: #141414;
            --bg-card-hover: #1a1a1a;
            --border: #2a2a2a;
            --text: #e0e0e0;
            --text-muted: #808080;
            --accent: #00d4aa;
            --accent-dim: #00a080;
            --verified: #00d4aa;
            --trusted: #00aaff;
            --untrusted: #ff6b6b;
            --warning: #ffaa00;
            --font-mono: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-mark {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--trusted) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: var(--bg-dark);
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .logo-sub {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 0.5rem;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--verified);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Layout */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        /* Query Section */
        .query-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .query-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .query-box h2 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .query-input-group {
            display: flex;
            gap: 0.75rem;
        }

        .query-input {
            flex: 1;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            color: var(--text);
            font-family: var(--font-sans);
            transition: border-color 0.2s;
        }

        .query-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .query-input::placeholder {
            color: var(--text-muted);
        }

        .query-btn {
            background: var(--accent);
            color: var(--bg-dark);
            border: none;
            border-radius: 8px;
            padding: 0 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .query-btn:hover {
            background: var(--accent-dim);
        }

        .query-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Regime Selector */
        .regime-selector {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .regime-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.875rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .regime-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .regime-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-dark);
        }

        /* Result Box */
        .result-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }

        .result-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trust-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trust-badge.trusted {
            background: rgba(0, 212, 170, 0.15);
            color: var(--verified);
        }

        .trust-badge.verified {
            background: rgba(0, 170, 255, 0.15);
            color: var(--trusted);
        }

        .trust-badge.untrusted {
            background: rgba(255, 107, 107, 0.15);
            color: var(--untrusted);
        }

        .result-value {
            padding: 1.5rem;
            font-size: 1.5rem;
            font-weight: 500;
            min-height: 80px;
            display: flex;
            align-items: center;
        }

        .result-value.empty {
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 400;
        }

        .result-meta {
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .meta-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meta-value {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--text);
        }

        /* Trace Section */
        .trace-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .trace-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trace-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trace-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .trace-stage {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 0.875rem 1.5rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .trace-stage:last-child {
            border-bottom: none;
        }

        .stage-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .stage-num.ok {
            background: var(--verified);
            color: var(--bg-dark);
        }

        .stage-num.fail {
            background: var(--untrusted);
            color: white;
        }

        .stage-name {
            font-weight: 500;
            color: var(--text);
        }

        .stage-details {
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .sidebar-title {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .quick-btn {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .quick-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent);
        }

        .quick-btn .icon {
            font-size: 1.1rem;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .stat-item {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 0.875rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        /* Ledger Preview */
        .ledger-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .ledger-entry {
            background: var(--bg-dark);
            border-radius: 6px;
            padding: 0.625rem 0.75rem;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ledger-hash {
            color: var(--text-muted);
        }

        .ledger-idx {
            color: var(--accent);
            font-weight: 500;
        }

        /* Examples */
        .example-queries {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .example-query {
            background: var(--bg-dark);
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 0.625rem 0.75rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-query:hover {
            border-color: var(--border);
            color: var(--text);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.8rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        footer a {
            color: var(--accent);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-mark">N</div>
            <span class="logo-text">Nina</span>
            <span class="logo-sub">Verified Computation Service</span>
        </div>
        <div class="header-status">
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span>System Active</span>
            </div>
            <div class="status-indicator" id="kb-status">
                <span>KB: Loading...</span>
            </div>
        </div>
    </header>

    <main>
        <section class="query-section">
            <!-- Query Input -->
            <div class="query-box">
                <h2>Query</h2>
                <div class="query-input-group">
                    <input type="text" class="query-input" id="query-input" 
                           placeholder="Ask anything... e.g., What is the capital of France?">
                    <button class="query-btn" id="query-btn">Execute</button>
                </div>
                <div class="regime-selector">
                    <button class="regime-btn active" data-regime="factual">Factual</button>
                    <button class="regime-btn" data-regime="mathematical">Mathematical</button>
                    <button class="regime-btn" data-regime="conversational">Conversational</button>
                </div>
            </div>

            <!-- Result -->
            <div class="result-box" id="result-box">
                <div class="result-header">
                    <span class="result-title">Result</span>
                    <span class="trust-badge trusted" id="trust-badge" style="display: none;">
                        <span>‚úì</span>
                        <span id="trust-label">TRUSTED</span>
                    </span>
                </div>
                <div class="result-value empty" id="result-value">
                    Enter a query above to see verified results
                </div>
                <div class="result-source" id="result-source" style="display: none; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                    <span id="source-label">Source: Knowledge Base</span>
                </div>
                <div class="result-meta" id="result-meta" style="display: none;">
                    <div class="meta-item">
                        <span class="meta-label">Operations</span>
                        <span class="meta-value" id="meta-ops">‚Äî</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Time</span>
                        <span class="meta-value" id="meta-time">‚Äî</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Ledger</span>
                        <span class="meta-value" id="meta-ledger">‚Äî</span>
                    </div>
                </div>
            </div>

            <!-- Pipeline Trace -->
            <div class="trace-box" id="trace-box" style="display: none;">
                <div class="trace-header">
                    <span class="trace-title">Pipeline Trace</span>
                    <span id="trace-stages">0 stages</span>
                </div>
                <div class="trace-content" id="trace-content">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <aside class="sidebar">
            <!-- Quick Actions -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">Quick Actions</h3>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="quickAction('verify')">
                        <span class="icon">‚úì</span>
                        <span>Verify Claim</span>
                    </button>
                    <button class="quick-btn" onclick="quickAction('calculate')">
                        <span class="icon">‚àë</span>
                        <span>Calculate</span>
                    </button>
                    <button class="quick-btn" onclick="quickAction('lookup')">
                        <span class="icon">üîç</span>
                        <span>Knowledge Lookup</span>
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">System Stats</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-queries">0</div>
                        <div class="stat-label">Queries</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-verified">0</div>
                        <div class="stat-label">Verified</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-calcs">0</div>
                        <div class="stat-label">Calcs</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-uptime">0s</div>
                        <div class="stat-label">Uptime</div>
                    </div>
                </div>
            </div>

            <!-- Ledger -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">Provenance Ledger</h3>
                <div class="ledger-list" id="ledger-list">
                    <div class="ledger-entry">
                        <span class="ledger-idx">‚Äî</span>
                        <span class="ledger-hash">No entries yet</span>
                    </div>
                </div>
            </div>

            <!-- Example Queries -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">Try These</h3>
                <div class="example-queries">
                    <div class="example-query" onclick="setQuery('What is the capital of France?')">
                        What is the capital of France?
                    </div>
                    <div class="example-query" onclick="setQuery('What is the population of Japan?')">
                        What is the population of Japan?
                    </div>
                    <div class="example-query" onclick="setQuery('Calculate 2 + 3 * 4')">
                        Calculate 2 + 3 * 4
                    </div>
                    <div class="example-query" onclick="setQuery('Verify: Paris is the capital of France')">
                        Verify: Paris is the capital of France
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <footer>
        <p>Nina ‚Äî Newton Intelligence & Natural Assistant</p>
        <p>The constraint is the instruction. | <a href="/api/health">API Health</a> | <a href="/docs">API Docs</a></p>
    </footer>

    <script>
        // State
        let currentRegime = 'factual';
        let isLoading = false;

        // Elements
        const queryInput = document.getElementById('query-input');
        const queryBtn = document.getElementById('query-btn');
        const resultValue = document.getElementById('result-value');
        const trustBadge = document.getElementById('trust-badge');
        const trustLabel = document.getElementById('trust-label');
        const resultMeta = document.getElementById('result-meta');
        const traceBox = document.getElementById('trace-box');
        const traceContent = document.getElementById('trace-content');
        const traceStages = document.getElementById('trace-stages');

        // Regime selector
        document.querySelectorAll('.regime-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.regime-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentRegime = btn.dataset.regime;
            });
        });

        // Query execution
        queryBtn.addEventListener('click', executeQuery);
        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeQuery();
        });

        async function executeQuery() {
            const query = queryInput.value.trim();
            if (!query || isLoading) return;

            isLoading = true;
            queryBtn.disabled = true;
            queryBtn.innerHTML = '<span class="loading"></span>';
            resultValue.textContent = 'Processing...';
            resultValue.classList.add('empty');

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, regime: currentRegime })
                });

                const data = await response.json();
                displayResult(data);
                updateLedger();
                updateStats();
            } catch (error) {
                resultValue.textContent = `Error: ${error.message}`;
                resultValue.classList.add('empty');
            } finally {
                isLoading = false;
                queryBtn.disabled = false;
                queryBtn.textContent = 'Execute';
            }
        }

        function displayResult(data) {
            // Value
            if (data.value !== null && data.value !== undefined) {
                resultValue.textContent = typeof data.value === 'object' 
                    ? JSON.stringify(data.value) 
                    : data.value;
                resultValue.classList.remove('empty');
            } else {
                resultValue.textContent = data.error || 'No result';
                resultValue.classList.add('empty');
            }

            // Trust badge
            trustBadge.style.display = 'flex';
            trustLabel.textContent = data.trust_label;
            trustBadge.className = 'trust-badge ' + data.trust_label.toLowerCase();

            // Source indicator (check trace for source)
            const sourceElement = document.getElementById('result-source');
            const sourceLabel = document.getElementById('source-label');
            let source = 'Unknown';
            
            if (data.trace) {
                const abstractStage = data.trace.find(s => s.name === 'ABSTRACT_INTERPRET');
                if (abstractStage && abstractStage.details) {
                    const srcVal = abstractStage.details.source;
                    if (srcVal === 'ollama_governed') {
                        source = 'ü§ñ Ollama (qwen) ‚Äî Local LLM, governed';
                    } else if (srcVal && srcVal.startsWith('adan_')) {
                        source = 'üìö Knowledge Base ‚Äî Verified facts';
                    } else if (srcVal === 'computation') {
                        source = 'üßÆ Newton Engine ‚Äî Verified computation';
                    } else if (srcVal === 'fallback_kb') {
                        source = 'üìñ Fallback KB ‚Äî Basic facts';
                    } else if (srcVal) {
                        source = srcVal;
                    }
                }
            }
            
            sourceElement.style.display = 'block';
            sourceLabel.textContent = `Source: ${source}`;

            // Meta
            resultMeta.style.display = 'flex';
            document.getElementById('meta-ops').textContent = data.bounds?.operations || '‚Äî';
            document.getElementById('meta-time').textContent = `${data.elapsed_ms}ms`;
            document.getElementById('meta-ledger').textContent = 
                data.ledger_proof?.hash?.substring(0, 12) + '...' || '‚Äî';

            // Trace
            if (data.trace && data.trace.length > 0) {
                traceBox.style.display = 'block';
                traceStages.textContent = `${data.trace.length} stages`;
                traceContent.innerHTML = data.trace.map(stage => `
                    <div class="trace-stage">
                        <span class="stage-num ${stage.status === 'OK' ? 'ok' : 'fail'}">${stage.stage}</span>
                        <div>
                            <div class="stage-name">${stage.name}</div>
                            <div class="stage-details">${formatDetails(stage.details)}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function formatDetails(details) {
            if (!details) return '';
            if (typeof details === 'string') return details;
            return Object.entries(details)
                .map(([k, v]) => `${k}: ${typeof v === 'object' ? JSON.stringify(v) : v}`)
                .join(' | ');
        }

        function setQuery(query) {
            queryInput.value = query;
            queryInput.focus();
        }

        function quickAction(action) {
            if (action === 'verify') {
                setQuery('Verify: ');
            } else if (action === 'calculate') {
                setQuery('Calculate ');
                document.querySelector('[data-regime="mathematical"]').click();
            } else if (action === 'lookup') {
                setQuery('What is ');
            }
        }

        async function updateLedger() {
            try {
                const response = await fetch(`/api/ledger?regime=${currentRegime}&limit=5`);
                const data = await response.json();
                
                const ledgerList = document.getElementById('ledger-list');
                if (data.entries && data.entries.length > 0) {
                    ledgerList.innerHTML = data.entries.reverse().map(entry => `
                        <div class="ledger-entry">
                            <span class="ledger-idx">#${entry.index}</span>
                            <span class="ledger-hash">${entry.hash?.substring(0, 16)}...</span>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to update ledger:', e);
            }
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('stat-queries').textContent = data.queries || 0;
                document.getElementById('stat-verified').textContent = data.verifications || 0;
                document.getElementById('stat-calcs').textContent = data.calculations || 0;
                document.getElementById('stat-uptime').textContent = 
                    data.uptime_seconds < 60 ? `${Math.round(data.uptime_seconds)}s` :
                    `${Math.round(data.uptime_seconds / 60)}m`;

                // KB status
                const kbStatus = document.getElementById('kb-status');
                if (data.knowledge?.available) {
                    kbStatus.innerHTML = `<span style="color: var(--verified)">KB: ${data.knowledge.kb_hits || 0} hits</span>`;
                } else {
                    kbStatus.innerHTML = `<span style="color: var(--warning)">KB: Fallback</span>`;
                }
                
                // Ollama status
                if (data.ollama) {
                    const ollamaInfo = data.ollama.available 
                        ? `<span style="color: var(--verified)"> | LLM: ${data.ollama.model || 'qwen'} ‚úì</span>`
                        : `<span style="color: var(--text-muted)"> | LLM: offline</span>`;
                    kbStatus.innerHTML += ollamaInfo;
                }
            } catch (e) {
                console.error('Failed to update stats:', e);
            }
        }

        // Initial load
        updateStats();
        setInterval(updateStats, 5000);
    </script>
</body>
</html>
